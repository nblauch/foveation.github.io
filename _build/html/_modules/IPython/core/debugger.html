

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IPython.core.debugger &mdash; foveation 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            foveation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../read_me.html">A biologically-inspired foveated interface for deep vision models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Example notebooks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core Components</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/foveation.sensing.html">foveation.sensing package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/foveation.arch.html">foveation.arch package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/foveation.saccadenet.html">foveation.saccadenet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/foveation.trainer.html">foveation.trainer</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Utilities &amp; Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/foveation.utils.html">foveation.utils package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/foveation.demo.html">foveation.demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/foveation.paths.html">foveation.paths</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/foveation.probes.html">foveation.probes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/foveation.visualizer.html">foveation.visualizer</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">foveation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">IPython.core.debugger</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for IPython.core.debugger</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Pdb debugger class.</span>


<span class="sd">This is an extension to PDB which adds a number of new features.</span>
<span class="sd">Note that there is also the `IPython.terminal.debugger` class which provides UI</span>
<span class="sd">improvements.</span>

<span class="sd">We also strongly recommend to use this via the `ipdb` package, which provides</span>
<span class="sd">extra configuration options.</span>

<span class="sd">Among other things, this subclass of PDB:</span>
<span class="sd"> - supports many IPython magics like pdef/psource</span>
<span class="sd"> - hide frames in tracebacks based on `__tracebackhide__`</span>
<span class="sd"> - allows to skip frames based on `__debuggerskip__`</span>


<span class="sd">Global Configuration</span>
<span class="sd">--------------------</span>

<span class="sd">The IPython debugger will by read the global ``~/.pdbrc`` file.</span>
<span class="sd">That is to say you can list all commands supported by ipdb in your `~/.pdbrc`</span>
<span class="sd">configuration file, to globally configure pdb.</span>

<span class="sd">Example::</span>

<span class="sd">   # ~/.pdbrc</span>
<span class="sd">   skip_predicates debuggerskip false</span>
<span class="sd">   skip_hidden false</span>
<span class="sd">   context 25</span>

<span class="sd">Features</span>
<span class="sd">--------</span>

<span class="sd">The IPython debugger can hide and skip frames when printing or moving through</span>
<span class="sd">the stack. This can have a performance impact, so can be configures.</span>

<span class="sd">The skipping and hiding frames are configurable via the `skip_predicates`</span>
<span class="sd">command.</span>

<span class="sd">By default, frames from readonly files will be hidden, frames containing</span>
<span class="sd">``__tracebackhide__ = True`` will be hidden.</span>

<span class="sd">Frames containing ``__debuggerskip__`` will be stepped over, frames whose parent</span>
<span class="sd">frames value of ``__debuggerskip__`` is ``True`` will also be skipped.</span>

<span class="sd">    &gt;&gt;&gt; def helpers_helper():</span>
<span class="sd">    ...     pass</span>
<span class="sd">    ...</span>
<span class="sd">    ... def helper_1():</span>
<span class="sd">    ...     print(&quot;don&#39;t step in me&quot;)</span>
<span class="sd">    ...     helpers_helpers() # will be stepped over unless breakpoint set.</span>
<span class="sd">    ...</span>
<span class="sd">    ...</span>
<span class="sd">    ... def helper_2():</span>
<span class="sd">    ...     print(&quot;in me neither&quot;)</span>
<span class="sd">    ...</span>

<span class="sd">One can define a decorator that wraps a function between the two helpers:</span>

<span class="sd">    &gt;&gt;&gt; def pdb_skipped_decorator(function):</span>
<span class="sd">    ...</span>
<span class="sd">    ...</span>
<span class="sd">    ...     def wrapped_fn(*args, **kwargs):</span>
<span class="sd">    ...         __debuggerskip__ = True</span>
<span class="sd">    ...         helper_1()</span>
<span class="sd">    ...         __debuggerskip__ = False</span>
<span class="sd">    ...         result = function(*args, **kwargs)</span>
<span class="sd">    ...         __debuggerskip__ = True</span>
<span class="sd">    ...         helper_2()</span>
<span class="sd">    ...         # setting __debuggerskip__ to False again is not necessary</span>
<span class="sd">    ...         return result</span>
<span class="sd">    ...</span>
<span class="sd">    ...     return wrapped_fn</span>

<span class="sd">When decorating a function, ipdb will directly step into ``bar()`` by</span>
<span class="sd">default:</span>

<span class="sd">    &gt;&gt;&gt; @foo_decorator</span>
<span class="sd">    ... def bar(x, y):</span>
<span class="sd">    ...     return x * y</span>


<span class="sd">You can toggle the behavior with</span>

<span class="sd">    ipdb&gt; skip_predicates debuggerskip false</span>

<span class="sd">or configure it in your ``.pdbrc``</span>



<span class="sd">License</span>
<span class="sd">-------</span>

<span class="sd">Modified from the standard pdb.Pdb class to avoid including readline, so that</span>
<span class="sd">the command line completion of other programs which include this isn&#39;t</span>
<span class="sd">damaged.</span>

<span class="sd">In the future, this class will be expanded with improvements over the standard</span>
<span class="sd">pdb.</span>

<span class="sd">The original code in this file is mainly lifted out of cmd.py in Python 2.2,</span>
<span class="sd">with minor changes. Licensing should therefore be under the standard Python</span>
<span class="sd">terms.  For details on the PSF (Python Software Foundation) standard license,</span>
<span class="sd">see:</span>

<span class="sd">https://docs.python.org/2/license.html</span>


<span class="sd">All the changes since then are under the same license as IPython.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># *****************************************************************************</span>
<span class="c1">#</span>
<span class="c1">#       This file is licensed under the PSF license.</span>
<span class="c1">#</span>
<span class="c1">#       Copyright (C) 2001 Python Software Foundation, www.python.org</span>
<span class="c1">#       Copyright (C) 2005-2006 Fernando Perez. &lt;fperez@colorado.edu&gt;</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># *****************************************************************************</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">linecache</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">IPython</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_ipython</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.core.debugger_backport</span><span class="w"> </span><span class="kn">import</span> <span class="n">PdbClosureBackport</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">PyColorize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.utils.PyColorize</span><span class="w"> </span><span class="kn">import</span> <span class="n">TokenStream</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">FrameType</span>

<span class="c1"># We have to check this directly from sys.argv, config struct not yet available</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pdb</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pdb</span> <span class="k">as</span> <span class="n">_OldPdb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pygments.token</span><span class="w"> </span><span class="kn">import</span> <span class="n">Token</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">):</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">OldPdb</span><span class="p">(</span><span class="n">PdbClosureBackport</span><span class="p">,</span> <span class="n">_OldPdb</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">OldPdb</span> <span class="o">=</span> <span class="n">_OldPdb</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="c1"># otherwise circular import</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">IPython.core.interactiveshell</span><span class="w"> </span><span class="kn">import</span> <span class="n">InteractiveShell</span>

<span class="c1"># skip module docstests</span>
<span class="n">__skip_doctest__</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;ipdb&gt; &quot;</span>


<span class="c1"># Allow the set_trace code to operate outside of an ipython instance, even if</span>
<span class="c1"># it does so with some limitations.  The rest of this support is implemented in</span>
<span class="c1"># the Tracer constructor.</span>

<span class="n">DEBUGGERSKIP</span> <span class="o">=</span> <span class="s2">&quot;__debuggerskip__&quot;</span>


<span class="c1"># this has been implemented in Pdb in Python 3.13 (https://github.com/python/cpython/pull/106676</span>
<span class="c1"># on lower python versions, we backported the feature.</span>
<span class="n">CHAIN_EXCEPTIONS</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">BdbQuit_excepthook</span><span class="p">(</span><span class="n">et</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">excepthook</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception hook which handles `BdbQuit` exceptions.</span>

<span class="sd">    All other exceptions are processed using the `excepthook`</span>
<span class="sd">    parameter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s2">&quot;`BdbQuit_excepthook` is deprecated since version 5.1. It is still around only because it is still imported by ipdb.&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="n">RGX_EXTRA_INDENT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?&lt;=\n)\s+&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">strip_indentation</span><span class="p">(</span><span class="n">multiline_string</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">RGX_EXTRA_INDENT</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">multiline_string</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">decorate_fn_with_doc</span><span class="p">(</span><span class="n">new_fn</span><span class="p">,</span> <span class="n">old_fn</span><span class="p">,</span> <span class="n">additional_text</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make new_fn have old_fn&#39;s doc string. This is particularly useful</span>
<span class="sd">    for the ``do_...`` commands that hook into the help system.</span>
<span class="sd">    Adapted from from a comp.lang.python posting</span>
<span class="sd">    by Duncan Booth.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">new_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">old_fn</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">strip_indentation</span><span class="p">(</span><span class="n">old_fn</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span> <span class="o">+</span> <span class="n">additional_text</span>
    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Pdb</span><span class="p">(</span><span class="n">OldPdb</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Modified Pdb class, does not load readline.</span>

<span class="sd">    for a standalone version that uses prompt_toolkit, see</span>
<span class="sd">    `IPython.terminal.debugger.TerminalPdb` and</span>
<span class="sd">    `IPython.terminal.debugger.set_trace()`</span>


<span class="sd">    This debugger can hide and skip frames that are tagged according to some predicates.</span>
<span class="sd">    See the `skip_predicates` commands.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">shell</span><span class="p">:</span> <span class="n">InteractiveShell</span>
    <span class="n">_theme_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">_context</span><span class="p">:</span> <span class="nb">int</span>

    <span class="n">_chained_exceptions</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="ne">Exception</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">_chained_exception_index</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">if</span> <span class="n">CHAIN_EXCEPTIONS</span><span class="p">:</span>
        <span class="n">MAX_CHAINED_EXCEPTION_DEPTH</span> <span class="o">=</span> <span class="mi">999</span>

    <span class="n">default_predicates</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;tbhide&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;readonly&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;ipython_internal&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;debuggerskip&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">completekey</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new IPython debugger.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        completekey : default None</span>
<span class="sd">            Passed to pdb.Pdb.</span>
<span class="sd">        stdin : default None</span>
<span class="sd">            Passed to pdb.Pdb.</span>
<span class="sd">        stdout : default None</span>
<span class="sd">            Passed to pdb.Pdb.</span>
<span class="sd">        context : int</span>
<span class="sd">            Number of lines of source code context to show when</span>
<span class="sd">            displaying stacktrace information.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Passed to pdb.Pdb.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The possibilities are python version dependent, see the python</span>
<span class="sd">        docs for more info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ipdb issue, see https://github.com/ipython/ipython/issues/14811</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>

        <span class="c1"># `kwargs` ensures full compatibility with stdlib&#39;s `pdb.Pdb`.</span>
        <span class="n">OldPdb</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completekey</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># IPython changes...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span> <span class="o">=</span> <span class="n">get_ipython</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">save_main</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;__main__&quot;</span><span class="p">]</span>
            <span class="c1"># No IPython instance running, we must create one</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">IPython.terminal.interactiveshell</span><span class="w"> </span><span class="kn">import</span> <span class="n">TerminalInteractiveShell</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">shell</span> <span class="o">=</span> <span class="n">TerminalInteractiveShell</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
            <span class="c1"># needed by any code which calls __import__(&quot;__main__&quot;) after</span>
            <span class="c1"># the debugger was entered. See also #9941.</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;__main__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_main</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">theme_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">colors</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">theme_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">theme_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">theme_name</span>

        <span class="c1"># Add a python parser so we can syntax highlight source while</span>
        <span class="c1"># debugging.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">PyColorize</span><span class="o">.</span><span class="n">Parser</span><span class="p">(</span><span class="n">theme_name</span><span class="o">=</span><span class="n">theme_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_theme_name</span><span class="p">(</span><span class="n">theme_name</span><span class="p">)</span>

        <span class="c1"># Set the prompt - the default prompt is &#39;(Pdb)&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_hidden</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_skipped</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># list of predicates we use to skip frames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predicates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_predicates</span>

        <span class="k">if</span> <span class="n">CHAIN_EXCEPTIONS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chained_exceptions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chained_exception_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span>

    <span class="nd">@context</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># ipdb issue see https://github.com/ipython/ipython/issues/14811</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_theme_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_theme_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">theme_name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">theme</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PyColorize</span><span class="o">.</span><span class="n">theme_table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_theme_name</span><span class="p">]</span>

    <span class="c1">#</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_colors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheme</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shorthand access to the color table scheme selector method.&quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;set_colors is deprecated since IPython 9.0, use set_theme_name instead&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">scheme</span> <span class="o">==</span> <span class="n">scheme</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_theme_name</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">theme_name</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_frame</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_trace</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">stack</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_stack</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_internal_frame</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">stack</span><span class="p">,</span> <span class="n">pos</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_internal_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if this frame should be skipped as internal&quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span>

        <span class="c1"># Skip bdb.py runcall and internal operations</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;bdb.py&quot;</span><span class="p">):</span>
            <span class="n">func_name</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
            <span class="c1"># Skip internal bdb operations but allow breakpoint hits</span>
            <span class="k">if</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;runcall&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="s2">&quot;runeval&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_hidden_predicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a frame return whether it it should be hidden or not by IPython.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predicates</span><span class="p">[</span><span class="s2">&quot;readonly&quot;</span><span class="p">]:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span>
            <span class="c1"># we need to check for file existence and interactively define</span>
            <span class="c1"># function would otherwise appear as RO.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predicates</span><span class="p">[</span><span class="s2">&quot;tbhide&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">frame</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;initial_frame&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">frame_locals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_locals</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;__tracebackhide__&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">frame_locals</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">frame_locals</span><span class="p">[</span><span class="s2">&quot;__tracebackhide__&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">hidden_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given an index in the stack return whether it should be skipped.</span>

<span class="sd">        This is used in up/down and where to skip frames.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The f_locals dictionary is updated from the actual frame</span>
        <span class="c1"># locals whenever the .f_locals accessor is called, so we</span>
        <span class="c1"># avoid calling it here to preserve self.curframe_locals.</span>
        <span class="c1"># Furthermore, there is no good reason to hide the current frame.</span>
        <span class="n">ip_hide</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_hidden_predicate</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">]</span>
        <span class="n">ip_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ip_hide</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;__ipython_bottom__&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ip_start</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predicates</span><span class="p">[</span><span class="s2">&quot;ipython_internal&quot;</span><span class="p">]:</span>
            <span class="n">ip_hide</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">ip_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="kc">True</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ip_hide</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">ip_hide</span>

    <span class="k">if</span> <span class="n">CHAIN_EXCEPTIONS</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_get_tb_and_exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tb_or_exc</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Given a tracecack or an exception, return a tuple of chained exceptions</span>
<span class="sd">            and current traceback to inspect.</span>
<span class="sd">            This will deal with selecting the right ``__cause__`` or ``__context__``</span>
<span class="sd">            as well as handling cycles, and return a flattened list of exceptions we</span>
<span class="sd">            can jump to with do_exceptions.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">_exceptions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tb_or_exc</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">):</span>
                <span class="n">traceback</span><span class="p">,</span> <span class="n">current</span> <span class="o">=</span> <span class="n">tb_or_exc</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">,</span> <span class="n">tb_or_exc</span>

                <span class="k">while</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">current</span> <span class="ow">in</span> <span class="n">_exceptions</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">_exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">current</span><span class="o">.</span><span class="n">__cause__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">__cause__</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">current</span><span class="o">.</span><span class="n">__context__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">current</span><span class="o">.</span><span class="n">__suppress_context__</span>
                    <span class="p">):</span>
                        <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">__context__</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_exceptions</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CHAINED_EXCEPTION_DEPTH</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;More than </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">MAX_CHAINED_EXCEPTION_DEPTH</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="s2">&quot; chained exceptions found, not all exceptions&quot;</span>
                            <span class="s2">&quot;will be browsable with `exceptions`.&quot;</span>
                        <span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">traceback</span> <span class="o">=</span> <span class="n">tb_or_exc</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">_exceptions</span><span class="p">)),</span> <span class="n">traceback</span>

        <span class="nd">@contextmanager</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_hold_exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Context manager to ensure proper cleaning of exceptions references</span>
<span class="sd">            When given a chained exception instead of a traceback,</span>
<span class="sd">            pdb may hold references to many objects which may leak memory.</span>
<span class="sd">            We use this context manager to make sure everything is properly cleaned</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_chained_exceptions</span> <span class="o">=</span> <span class="n">exceptions</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_chained_exception_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">exceptions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">yield</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># we can&#39;t put those in forget as otherwise they would</span>
                <span class="c1"># be cleared on exception change</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_chained_exceptions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_chained_exception_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">do_exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;exceptions [number]</span>
<span class="sd">            List or change current exception in an exception chain.</span>
<span class="sd">            Without arguments, list all the current exception in the exception</span>
<span class="sd">            chain. Exceptions will be numbered, with the current exception indicated</span>
<span class="sd">            with an arrow.</span>
<span class="sd">            If given an integer as argument, switch to the exception at that index.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chained_exceptions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span>
                    <span class="s2">&quot;Did not find chained exceptions. To move between&quot;</span>
                    <span class="s2">&quot; exceptions, pdb/post_mortem must be given an exception&quot;</span>
                    <span class="s2">&quot; object rather than a traceback.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">exc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_chained_exceptions</span><span class="p">):</span>
                    <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chained_exception_index</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span>
                    <span class="n">rep</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">:</span>
                        <span class="n">rep</span> <span class="o">=</span> <span class="n">rep</span><span class="p">[:</span><span class="mi">77</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
                    <span class="n">indicator</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;  -&quot;</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chained_exceptions</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">__traceback__</span> <span class="ow">is</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ix</span><span class="si">:</span><span class="s2">&gt;3</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">indicator</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rep</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Argument must be an integer&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">number</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_chained_exceptions</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chained_exceptions</span><span class="p">[</span><span class="n">number</span><span class="p">]</span><span class="o">.</span><span class="n">__traceback__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;This exception does not have a traceback, cannot jump to it&quot;</span>
                        <span class="p">)</span>
                        <span class="k">return</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_chained_exception_index</span> <span class="o">=</span> <span class="n">number</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chained_exceptions</span><span class="p">[</span><span class="n">number</span><span class="p">]</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">print_stack_entry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">curindex</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No exception with that number&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">tb_or_exc</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">CHAIN_EXCEPTIONS</span><span class="p">:</span>
                <span class="c1"># this context manager is part of interaction in 3.13</span>
                <span class="n">_chained_exceptions</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tb_and_exceptions</span><span class="p">(</span><span class="n">tb_or_exc</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tb_or_exc</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">tb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;main exception must have a traceback&quot;</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hold_exceptions</span><span class="p">(</span><span class="n">_chained_exceptions</span><span class="p">):</span>
                    <span class="n">OldPdb</span><span class="o">.</span><span class="n">interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">OldPdb</span><span class="o">.</span><span class="n">interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">tb_or_exc</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">get_exception_only</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">precmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform useful escapes on the command before it is executed.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;??&quot;</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pinfo2 &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pinfo &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">line</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">precmd</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">line</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">new_do_quit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OldPdb</span><span class="o">.</span><span class="n">do_quit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

    <span class="n">do_q</span> <span class="o">=</span> <span class="n">do_quit</span> <span class="o">=</span> <span class="n">decorate_fn_with_doc</span><span class="p">(</span><span class="n">new_do_quit</span><span class="p">,</span> <span class="n">OldPdb</span><span class="o">.</span><span class="n">do_quit</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">print_stack_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">to_print</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">frame_lineno</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">hidden</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_hidden</span><span class="p">:</span>
                    <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">skipped</span><span class="p">:</span>
                    <span class="n">to_print</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theme</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="p">(</span>
                                <span class="n">Token</span><span class="o">.</span><span class="n">ExcName</span><span class="p">,</span>
                                <span class="sa">f</span><span class="s2">&quot;    [... skipping </span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="s2"> hidden frame(s)]&quot;</span><span class="p">,</span>
                            <span class="p">),</span>
                            <span class="p">(</span><span class="n">Token</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="p">)</span>

                    <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">to_print</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_stack_entry</span><span class="p">(</span><span class="n">frame_lineno</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">skipped</span><span class="p">:</span>
                <span class="n">to_print</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theme</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span>
                            <span class="n">Token</span><span class="o">.</span><span class="n">ExcName</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;    [... skipping </span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="s2"> hidden frame(s)]&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="p">(</span><span class="n">Token</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">to_print</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">print_stack_entry</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">frame_lineno</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">FrameType</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">prompt_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">-&gt; &quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overwrite print_stack_entry from superclass (PDB)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_stack_entry</span><span class="p">(</span><span class="n">frame_lineno</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

        <span class="n">frame</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">frame_lineno</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">synchronize_with_editor</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_frame_locals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;</span>
<span class="sd">        Accessing f_local of current frame reset the namespace, so we want to avoid</span>
<span class="sd">        that or the following can happen</span>

<span class="sd">        ipdb&gt; foo</span>
<span class="sd">        &quot;old&quot;</span>
<span class="sd">        ipdb&gt; foo = &quot;new&quot;</span>
<span class="sd">        ipdb&gt; foo</span>
<span class="sd">        &quot;new&quot;</span>
<span class="sd">        ipdb&gt; where</span>
<span class="sd">        ipdb&gt; foo</span>
<span class="sd">        &quot;old&quot;</span>

<span class="sd">        So if frame is self.current_frame we instead return self.curframe_locals</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;curframe&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe_locals</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_stack_entry</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">frame_lineno</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">FrameType</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>  <span class="c1"># type: ignore[override] # stubs are wrong</span>
        <span class="n">lprefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;: &quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        overwrite from super class so must -&gt; str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">context</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Context must be a positive integer&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Context must be a positive integer&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">reprlib</span>

        <span class="n">ret_tok</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">frame</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">frame_lineno</span>

        <span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">loc_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_locals</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;__return__&quot;</span> <span class="ow">in</span> <span class="n">loc_frame</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">loc_frame</span><span class="p">[</span><span class="s2">&quot;__return__&quot;</span><span class="p">]</span>
            <span class="c1"># return_value += &#39;-&gt;&#39;</span>
            <span class="n">return_value</span> <span class="o">+=</span> <span class="n">reprlib</span><span class="o">.</span><span class="n">repr</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">ret_tok</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">Token</span><span class="p">,</span> <span class="n">return_value</span><span class="p">)])</span>

        <span class="c1"># s = filename + &#39;(&#39; + `lineno` + &#39;)&#39;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonic</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">)</span>
        <span class="n">link_tok</span> <span class="o">=</span> <span class="p">(</span><span class="n">Token</span><span class="o">.</span><span class="n">FilenameEm</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="s2">&quot;&lt;lambda&gt;&quot;</span>

        <span class="n">call_toks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">func</span> <span class="o">!=</span> <span class="s2">&quot;?&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;__args__&quot;</span> <span class="ow">in</span> <span class="n">loc_frame</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">reprlib</span><span class="o">.</span><span class="n">repr</span><span class="p">(</span><span class="n">loc_frame</span><span class="p">[</span><span class="s2">&quot;__args__&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;()&quot;</span>
            <span class="n">call_toks</span> <span class="o">=</span> <span class="p">[(</span><span class="n">Token</span><span class="o">.</span><span class="n">VName</span><span class="p">,</span> <span class="n">func</span><span class="p">),</span> <span class="p">(</span><span class="n">Token</span><span class="o">.</span><span class="n">ValEm</span><span class="p">,</span> <span class="n">args</span><span class="p">)]</span>

        <span class="c1"># The level info should be generated in the same format pdb uses, to</span>
        <span class="c1"># avoid breaking the pdbtrack functionality of python-mode in *emacs.</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="p">:</span>
            <span class="n">ret_tok</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">Token</span><span class="o">.</span><span class="n">CurrentFrame</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theme</span><span class="o">.</span><span class="n">make_arrow</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret_tok</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">Token</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">))</span>

        <span class="n">ret_tok</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">link_tok</span><span class="p">,</span>
                <span class="p">(</span><span class="n">Token</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">Token</span><span class="o">.</span><span class="n">Lineno</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lineno</span><span class="p">)),</span>
                <span class="p">(</span><span class="n">Token</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">),</span>
                <span class="o">*</span><span class="n">call_toks</span><span class="p">,</span>
                <span class="p">(</span><span class="n">Token</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">lineno</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">context</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">linecache</span><span class="o">.</span><span class="n">getlines</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">start</span> <span class="p">:</span> <span class="n">start</span> <span class="o">+</span> <span class="n">context</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">show_arrow</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">==</span> <span class="n">lineno</span>

            <span class="n">bp</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">colored_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__line_content</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span>
                <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                <span class="n">line</span><span class="p">,</span>
                <span class="n">arrow</span><span class="o">=</span><span class="n">show_arrow</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span> <span class="ow">or</span> <span class="n">show_arrow</span><span class="p">:</span>
                <span class="n">rlt</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">bp</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">Token</span><span class="o">.</span><span class="n">LinenoEm</span><span class="p">,</span> <span class="n">num</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">Token</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span>
                    <span class="c1"># TODO: investigate Toke.Line here, likely LineEm,</span>
                    <span class="c1"># Token is problematic here as line is already colored, a</span>
                    <span class="c1"># and this changes the full style of the colored line.</span>
                    <span class="c1"># ideally, __line_content returns the token and we modify the style.</span>
                    <span class="p">(</span><span class="n">Token</span><span class="p">,</span> <span class="n">colored_line</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rlt</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">bp</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">Token</span><span class="o">.</span><span class="n">Lineno</span><span class="p">,</span> <span class="n">num</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">Token</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span>
                    <span class="c1"># TODO: investigate Toke.Line here, likely Line</span>
                    <span class="c1"># Token is problematic here as line is already colored, a</span>
                    <span class="c1"># and this changes the full style of the colored line.</span>
                    <span class="c1"># ideally, __line_content returns the token and we modify the style.</span>
                    <span class="p">(</span><span class="n">Token</span><span class="o">.</span><span class="n">Line</span><span class="p">,</span> <span class="n">colored_line</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="n">ret_tok</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rlt</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">theme</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ret_tok</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__line_content</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lineno</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arrow</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
        <span class="n">bp_mark</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">BreakpointToken</span> <span class="o">=</span> <span class="n">Token</span><span class="o">.</span><span class="n">Breakpoint</span>

        <span class="n">new_line</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">format2</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s2">&quot;str&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">new_line</span>

        <span class="n">bp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">lineno</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_file_breaks</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">bps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_breaks</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
            <span class="n">bp</span> <span class="o">=</span> <span class="n">bps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">bp</span><span class="p">:</span>
            <span class="n">bp_mark</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
            <span class="n">BreakpointToken</span> <span class="o">=</span> <span class="n">Token</span><span class="o">.</span><span class="n">Breakpoint</span><span class="o">.</span><span class="n">Enabled</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bp</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                <span class="n">BreakpointToken</span> <span class="o">=</span> <span class="n">Token</span><span class="o">.</span><span class="n">Breakpoint</span><span class="o">.</span><span class="n">Disabled</span>
        <span class="n">numbers_width</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="k">if</span> <span class="n">arrow</span><span class="p">:</span>
            <span class="c1"># This is the line with the error</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="n">numbers_width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lineno</span><span class="p">))</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">bp_mark</span><span class="p">)</span>
            <span class="n">num</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theme</span><span class="o">.</span><span class="n">make_arrow</span><span class="p">(</span><span class="n">pad</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">lineno</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%*s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numbers_width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">bp_mark</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">lineno</span><span class="p">))</span>
        <span class="n">bp_str</span> <span class="o">=</span> <span class="p">(</span><span class="n">BreakpointToken</span><span class="p">,</span> <span class="n">bp_mark</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">bp_str</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">print_list_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">first</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">last</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The printing (as opposed to the parsing part of a &#39;list&#39;</span>
<span class="sd">        command.&quot;&quot;&quot;</span>
        <span class="n">toks</span><span class="p">:</span> <span class="n">TokenStream</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;&lt;string&gt;&quot;</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_exec_filename&quot;</span><span class="p">):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exec_filename</span>

            <span class="k">for</span> <span class="n">lineno</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">linecache</span><span class="o">.</span><span class="n">getline</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">lineno</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">:</span>
                    <span class="n">bp</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">colored_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__line_content</span><span class="p">(</span>
                        <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">arrow</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="n">toks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">bp</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">Token</span><span class="o">.</span><span class="n">LinenoEm</span><span class="p">,</span> <span class="n">num</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">Token</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span>
                            <span class="c1"># TODO: investigate Token.Line here</span>
                            <span class="p">(</span><span class="n">Token</span><span class="p">,</span> <span class="n">colored_line</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bp</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">colored_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__line_content</span><span class="p">(</span>
                        <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">arrow</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
                    <span class="n">toks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">bp</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">Token</span><span class="o">.</span><span class="n">Lineno</span><span class="p">,</span> <span class="n">num</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">Token</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">Token</span><span class="p">,</span> <span class="n">colored_line</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span> <span class="o">=</span> <span class="n">lineno</span>

            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theme</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">toks</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_skip_predicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turn on/off individual predicates as to whether a frame should be hidden/skip.</span>

<span class="sd">        The global option to skip (or not) hidden frames is set with skip_hidden</span>

<span class="sd">        To change the value of a predicate</span>

<span class="sd">            skip_predicates key [true|false]</span>

<span class="sd">        Call without arguments to see the current values.</span>

<span class="sd">        To permanently change the value of an option add the corresponding</span>
<span class="sd">        command to your ``~/.pdbrc`` file. If you are programmatically using the</span>
<span class="sd">        Pdb instance you can also change the ``default_predicates`` class</span>
<span class="sd">        attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;current predicates:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predicates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   &quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">type_value</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Usage: skip_predicates &lt;type&gt; &lt;value&gt;, with &lt;type&gt; one of </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predicates</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">type_</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">type_value</span>
        <span class="k">if</span> <span class="n">type_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predicates</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">type_</span><span class="si">!r}</span><span class="s2"> not in </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predicates</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2"> is invalid - use one of (&#39;true&#39;, &#39;yes&#39;, &#39;1&#39;, &#39;no&#39;, &#39;false&#39;, &#39;0&#39;)&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_predicates</span><span class="p">[</span><span class="n">type_</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predicates</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Warning, all predicates set to False, skip_hidden may not have any effects.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_skip_hidden</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change whether or not we should skip frames with the</span>
<span class="sd">        __tracebackhide__ attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;skip_hidden = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_hidden</span><span class="si">}</span><span class="s2">, use &#39;yes&#39;,&#39;no&#39;, &#39;true&#39;, or &#39;false&#39; to change.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip_hidden</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip_hidden</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predicates</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Warning, all predicates set to False, skip_hidden may not have any effects.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print lines of code from the current stack frame&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastcmd</span> <span class="o">=</span> <span class="s2">&quot;list&quot;</span>
        <span class="n">last</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">and</span> <span class="n">arg</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(()):</span>
                    <span class="n">first</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="n">x</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">last</span> <span class="o">&lt;</span> <span class="n">first</span><span class="p">:</span>
                        <span class="c1"># Assume it&#39;s a count</span>
                        <span class="n">last</span> <span class="o">=</span> <span class="n">first</span> <span class="o">+</span> <span class="n">last</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** Error in argument:&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">first</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="o">.</span><span class="n">f_lineno</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">first</span> <span class="o">+</span> <span class="mi">10</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_list_lines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span>

        <span class="n">lineno</span> <span class="o">=</span> <span class="n">first</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">synchronize_with_editor</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">do_l</span> <span class="o">=</span> <span class="n">do_list</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">getsourcelines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">lines</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">findsource</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isframe</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">f_globals</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_locals</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="c1"># must be a module frame: do not try to cut a block out of it</span>
            <span class="k">return</span> <span class="n">lines</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismodule</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">lines</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getblock</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">lineno</span><span class="p">:]),</span> <span class="n">lineno</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_longlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print lines of code from the current stack frame.</span>

<span class="sd">        Shows more lines than &#39;list&#39; does.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastcmd</span> <span class="o">=</span> <span class="s2">&quot;longlist&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">lineno</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_list_lines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span>

    <span class="n">do_ll</span> <span class="o">=</span> <span class="n">do_longlist</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;debug code</span>
<span class="sd">        Enter a recursive debugger that steps through the code</span>
<span class="sd">        argument (which is an arbitrary expression or statement to be</span>
<span class="sd">        executed in the current environment).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">trace_function</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">gettrace</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="nb">globals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="o">.</span><span class="n">f_globals</span>
        <span class="nb">locals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe_locals</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">completekey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">completekey</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span>
        <span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">use_rawinput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_rawinput</span>
        <span class="n">p</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;ENTERING RECURSIVE DEBUGGER&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">call_tracing</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;LEAVING RECURSIVE DEBUGGER&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">trace_function</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastcmd</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">lastcmd</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_pdef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print the call signature for any callable object.</span>

<span class="sd">        The debugger interface to %pdef&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">namespaces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;Locals&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe_locals</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Globals&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="o">.</span><span class="n">f_globals</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">find_line_magic</span><span class="p">(</span><span class="s2">&quot;pdef&quot;</span><span class="p">)(</span><span class="n">arg</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_pdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print the docstring for an object.</span>

<span class="sd">        The debugger interface to %pdoc.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">namespaces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;Locals&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe_locals</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Globals&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="o">.</span><span class="n">f_globals</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">find_line_magic</span><span class="p">(</span><span class="s2">&quot;pdoc&quot;</span><span class="p">)(</span><span class="n">arg</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_pfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print (or run through pager) the file where an object is defined.</span>

<span class="sd">        The debugger interface to %pfile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">namespaces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;Locals&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe_locals</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Globals&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="o">.</span><span class="n">f_globals</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">find_line_magic</span><span class="p">(</span><span class="s2">&quot;pfile&quot;</span><span class="p">)(</span><span class="n">arg</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_pinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide detailed information about an object.</span>

<span class="sd">        The debugger interface to %pinfo, i.e., obj?.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">namespaces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;Locals&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe_locals</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Globals&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="o">.</span><span class="n">f_globals</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">find_line_magic</span><span class="p">(</span><span class="s2">&quot;pinfo&quot;</span><span class="p">)(</span><span class="n">arg</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_pinfo2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide extra detailed information about an object.</span>

<span class="sd">        The debugger interface to %pinfo2, i.e., obj??.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">namespaces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;Locals&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe_locals</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Globals&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="o">.</span><span class="n">f_globals</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">find_line_magic</span><span class="p">(</span><span class="s2">&quot;pinfo2&quot;</span><span class="p">)(</span><span class="n">arg</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_psource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print (or run through pager) the source code for an object.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">namespaces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;Locals&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe_locals</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Globals&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="o">.</span><span class="n">f_globals</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">find_line_magic</span><span class="p">(</span><span class="s2">&quot;psource&quot;</span><span class="p">)(</span><span class="n">arg</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;w(here)</span>
<span class="sd">        Print a stack trace, with the most recent frame at the bottom.</span>
<span class="sd">        An arrow indicates the &quot;current frame&quot;, which determines the</span>
<span class="sd">        context of most commands. &#39;bt&#39; is an alias for this command.</span>

<span class="sd">        Take a number as argument as an (optional) number of context line to</span>
<span class="sd">        print&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">arg</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_stack_trace</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_stack_trace</span><span class="p">()</span>

    <span class="n">do_w</span> <span class="o">=</span> <span class="n">do_where</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">break_anywhere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _stop_in_decorator_internals is overly restrictive, as we may still want</span>
<span class="sd">        to trace function calls, so we need to also update break_anywhere so</span>
<span class="sd">        that is we don&#39;t `stop_here`, because of debugger skip, we may still</span>
<span class="sd">        stop at any point inside the function</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sup</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">break_anywhere</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sup</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sup</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predicates</span><span class="p">[</span><span class="s2">&quot;debuggerskip&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">DEBUGGERSKIP</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_back</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_locals</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_back</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">DEBUGGERSKIP</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_in_decorator_internal_and_should_skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Utility to tell us whether we are in a decorator internal and should stop.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if we are disabled don&#39;t skip</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predicates</span><span class="p">[</span><span class="s2">&quot;debuggerskip&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cachable_skip</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="nd">@lru_cache</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_cached_one_parent_frame_debuggerskip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cache looking up for DEBUGGERSKIP on parent frame.</span>

<span class="sd">        This should speedup walking through deep frame when one of the highest</span>
<span class="sd">        one does have a debugger skip.</span>

<span class="sd">        This is likely to introduce fake positive though.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s2">&quot;f_back&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_back</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_locals</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">DEBUGGERSKIP</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@lru_cache</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_cachable_skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="c1"># if frame is tagged, skip by default.</span>
        <span class="k">if</span> <span class="n">DEBUGGERSKIP</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># if one of the parent frame value set to True skip as well.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_one_parent_frame_debuggerskip</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stop_here</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_in_decorator_internal_and_should_skip</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">hidden</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_hidden</span><span class="p">:</span>
            <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_predicate</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hidden</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_skipped</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">theme</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="p">(</span>
                                <span class="n">Token</span><span class="o">.</span><span class="n">ExcName</span><span class="p">,</span>
                                <span class="s2">&quot;    [... skipped 1 hidden frame(s)]&quot;</span><span class="p">,</span>
                            <span class="p">),</span>
                            <span class="p">(</span><span class="n">Token</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_skipped_module</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theme</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span>
                            <span class="n">Token</span><span class="o">.</span><span class="n">ExcName</span><span class="p">,</span>
                            <span class="s2">&quot;    [... skipped 1 ignored module(s)]&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="p">(</span><span class="n">Token</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">stop_here</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;u(p) [count]</span>
<span class="sd">        Move the current frame count (default one) levels up in the</span>
<span class="sd">        stack trace (to an older frame).</span>

<span class="sd">        Will skip hidden frames and ignored modules.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># modified version of upstream that skips</span>
        <span class="c1"># frames with __tracebackhide__ and ignored modules</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curindex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Oldest frame&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid frame count (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">hidden_skipped</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">module_skipped</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_newframe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">hidden_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curindex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">should_skip_hidden</span> <span class="o">=</span> <span class="n">hidden_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_hidden</span>
                <span class="n">should_skip_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_skipped_module</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">f_globals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">should_skip_hidden</span> <span class="ow">or</span> <span class="n">should_skip_module</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">should_skip_hidden</span><span class="p">:</span>
                        <span class="n">hidden_skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">should_skip_module</span><span class="p">:</span>
                        <span class="n">module_skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if no break occurred.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;all frames above skipped (hidden frames and ignored modules). Use `skip_hidden False` for hidden frames or unignore_module for ignored modules.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="n">_newframe</span> <span class="o">=</span> <span class="n">i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_frame</span><span class="p">(</span><span class="n">_newframe</span><span class="p">)</span>

        <span class="n">total_skipped</span> <span class="o">=</span> <span class="n">hidden_skipped</span> <span class="o">+</span> <span class="n">module_skipped</span>
        <span class="k">if</span> <span class="n">total_skipped</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theme</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span>
                            <span class="n">Token</span><span class="o">.</span><span class="n">ExcName</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;    [... skipped </span><span class="si">{</span><span class="n">total_skipped</span><span class="si">}</span><span class="s2"> frame(s): </span><span class="si">{</span><span class="n">hidden_skipped</span><span class="si">}</span><span class="s2"> hidden frames + </span><span class="si">{</span><span class="n">module_skipped</span><span class="si">}</span><span class="s2"> ignored modules]&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="p">(</span><span class="n">Token</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;d(own) [count]</span>
<span class="sd">        Move the current frame count (default one) levels down in the</span>
<span class="sd">        stack trace (to a newer frame).</span>

<span class="sd">        Will skip hidden frames and ignored modules.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curindex</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Newest frame&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid frame count (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_newframe</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">hidden_skipped</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">module_skipped</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">hidden_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curindex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)):</span>
                <span class="n">should_skip_hidden</span> <span class="o">=</span> <span class="n">hidden_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_hidden</span>
                <span class="n">should_skip_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_skipped_module</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">f_globals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">should_skip_hidden</span> <span class="ow">or</span> <span class="n">should_skip_module</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">should_skip_hidden</span><span class="p">:</span>
                        <span class="n">hidden_skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">should_skip_module</span><span class="p">:</span>
                        <span class="n">module_skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;all frames below skipped (hidden frames and ignored modules). Use `skip_hidden False` for hidden frames or unignore_module for ignored modules.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="n">total_skipped</span> <span class="o">=</span> <span class="n">hidden_skipped</span> <span class="o">+</span> <span class="n">module_skipped</span>
            <span class="k">if</span> <span class="n">total_skipped</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">theme</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="p">(</span>
                                <span class="n">Token</span><span class="o">.</span><span class="n">ExcName</span><span class="p">,</span>
                                <span class="sa">f</span><span class="s2">&quot;    [... skipped </span><span class="si">{</span><span class="n">total_skipped</span><span class="si">}</span><span class="s2"> frame(s): </span><span class="si">{</span><span class="n">hidden_skipped</span><span class="si">}</span><span class="s2"> hidden frames + </span><span class="si">{</span><span class="n">module_skipped</span><span class="si">}</span><span class="s2"> ignored modules]&quot;</span><span class="p">,</span>
                            <span class="p">),</span>
                            <span class="p">(</span><span class="n">Token</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">_newframe</span> <span class="o">=</span> <span class="n">i</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_select_frame</span><span class="p">(</span><span class="n">_newframe</span><span class="p">)</span>

    <span class="n">do_d</span> <span class="o">=</span> <span class="n">do_down</span>
    <span class="n">do_u</span> <span class="o">=</span> <span class="n">do_up</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_show_ignored_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display currently ignored modules.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Currently ignored modules: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No modules are currently ignored.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_ignore_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ignore_module &lt;module_name&gt;</span>

<span class="sd">        Add a module to the list of modules to skip when navigating frames.</span>
<span class="sd">        When a module is ignored, the debugger will automatically skip over</span>
<span class="sd">        frames from that module.</span>

<span class="sd">        Supports wildcard patterns using fnmatch syntax:</span>

<span class="sd">        Usage:</span>
<span class="sd">            ignore_module threading     # Skip threading module frames</span>
<span class="sd">            ignore_module asyncio.\\*    # Skip all asyncio submodules</span>
<span class="sd">            ignore_module \\*.tests      # Skip all test modules</span>
<span class="sd">            ignore_module               # List currently ignored modules</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">module_name</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">module_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_show_ignored_modules</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_unignore_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;unignore_module &lt;module_name&gt;</span>

<span class="sd">        Remove a module from the list of modules to skip when navigating frames.</span>
<span class="sd">        This will allow the debugger to step into frames from the specified module.</span>

<span class="sd">        Usage:</span>
<span class="sd">            unignore_module threading   # Stop ignoring threading module frames</span>
<span class="sd">            unignore_module asyncio.\\*  # Remove asyncio.* pattern</span>
<span class="sd">            unignore_module             # List currently ignored modules</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">module_name</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">module_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_show_ignored_modules</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Module </span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2"> is not currently ignored&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_show_ignored_modules</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;context number_of_lines</span>
<span class="sd">        Set the number of lines of source code to show when displaying</span>
<span class="sd">        stacktrace information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_context</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_context</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">new_context</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The &#39;context&#39; command requires a positive integer argument (current value </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="si">}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">InterruptiblePdb</span><span class="p">(</span><span class="n">Pdb</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Version of debugger where KeyboardInterrupt exits the debugger altogether.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cmdloop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intro</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrap cmdloop() such that KeyboardInterrupt stops the debugger.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OldPdb</span><span class="o">.</span><span class="n">cmdloop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intro</span><span class="o">=</span><span class="n">intro</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_here</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">frame</span><span class="p">:</span> <span class="kc">False</span>  <span class="c1"># type: ignore[method-assign]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_quit</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quitting</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_cmdloop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># keyboard interrupts allow for an easy way to cancel</span>
                <span class="c1"># the current command, so allow them during interactive input</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allow_kbdint</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cmdloop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allow_kbdint</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;--KeyboardInterrupt--&quot;</span><span class="p">)</span>
                <span class="k">raise</span>


<div class="viewcode-block" id="set_trace">
<a class="viewcode-back" href="../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.set_trace">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">set_trace</span><span class="p">(</span><span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start debugging from `frame`.</span>

<span class="sd">    If frame is not specified, debugging starts from caller&#39;s frame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pdb</span> <span class="o">=</span> <span class="n">Pdb</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pdb</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">(</span><span class="n">frame</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>