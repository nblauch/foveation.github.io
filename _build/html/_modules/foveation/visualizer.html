

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>foveation.visualizer &mdash; foveation 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            foveation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../read_me.html">A biologically-inspired foveated interface for deep vision models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core Components</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/foveation.sensing.html">foveation.sensing package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/foveation.arch.html">foveation.arch package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/foveation.saccadenet.html">foveation.saccadenet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/foveation.trainer.html">foveation.trainer</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Utilities &amp; Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/foveation.utils.html">foveation.utils package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/foveation.demo.html">foveation.demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/foveation.paths.html">foveation.paths</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/foveation.probes.html">foveation.probes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/foveation.visualizer.html">foveation.visualizer</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">foveation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../foveation.html">foveation</a></li>
      <li class="breadcrumb-item active">foveation.visualizer</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for foveation.visualizer</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageGrid</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">einops</span><span class="w"> </span><span class="kn">import</span> <span class="n">rearrange</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.amp</span><span class="w"> </span><span class="kn">import</span> <span class="n">autocast</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.paths</span><span class="w"> </span><span class="kn">import</span> <span class="n">FIGS_DIR</span><span class="p">,</span> <span class="n">SLOW_DIR</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.arch.knn</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_receptive_field</span><span class="p">,</span> <span class="n">compute_binary_receptive_field</span><span class="p">,</span> <span class="n">KNNBaseLayer</span><span class="p">,</span> <span class="n">KNNConvLayer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.sensing.coords</span><span class="w"> </span><span class="kn">import</span> <span class="n">transform_sampling_grid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_model</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">add_to_all</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="Visualizer">
<a class="viewcode-back" href="../../api/foveation.visualizer.html#foveation.visualizer.Visualizer">[docs]</a>
<span class="nd">@add_to_all</span><span class="p">(</span><span class="n">__all__</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Visualizer</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class for visualizing model results and analysis.</span>

<span class="sd">    This class provides methods to visualize various aspects of a model&#39;s behavior and performance,</span>
<span class="sd">    including receptive fields, sampling grids, fixation patterns, and accuracy metrics.</span>
<span class="sd">    It handles saving visualizations to disk and displaying them interactively.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        trainer: The trainer object containing the model and training configuration</span>
<span class="sd">        model: The underlying model being visualized</span>
<span class="sd">        out_base_dir: Base directory for saving visualization outputs</span>
<span class="sd">        out_dir: Full output directory path for this specific model&#39;s visualizations</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Visualizer.__init__">
<a class="viewcode-back" href="../../api/foveation.visualizer.html#foveation.visualizer.Visualizer.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">out_base_dir</span><span class="o">=</span><span class="n">FIGS_DIR</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="n">trainer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">trainer</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">distributed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_base_dir</span> <span class="o">=</span> <span class="n">out_base_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_base_dir</span><span class="p">,</span> <span class="s1">&#39;model_results&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">cfg_dict_flat</span><span class="p">[</span><span class="s1">&#39;logging.base_fn&#39;</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="Visualizer.multi_fixation_accuracy">
<a class="viewcode-back" href="../../api/foveation.visualizer.html#foveation.visualizer.Visualizer.multi_fixation_accuracy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">multi_fixation_accuracy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_fixations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_fixations</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">areas</span><span class="o">=</span><span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span> <span class="n">norm_dist_from_center</span><span class="o">=</span><span class="s1">&#39;original&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                <span class="n">max_batches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">probe_layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">cache_accuracy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite_accuracy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="p">):</span>
        <span class="n">all_accs</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">if</span> <span class="n">probe_layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">layer_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;projector&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">training</span><span class="o">.</span><span class="n">no_probes</span><span class="p">,</span> <span class="s1">&#39;probes were not trained, do not try to test them&#39;</span>
            <span class="n">probe_layers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;backbone&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">projector</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">_modules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">layer_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">probe_layers</span><span class="p">[</span><span class="n">probe_layer</span><span class="p">]]</span>
        
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">,</span> <span class="n">max_batches</span><span class="o">=</span><span class="n">max_batches</span><span class="p">,</span> <span class="n">layer_names</span><span class="o">=</span><span class="n">layer_names</span><span class="p">)</span>
        
        <span class="n">loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">val_loader</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">training</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">train_loader</span>
        
        <span class="n">nd_from_center_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sup_fixator</span><span class="o">.</span><span class="n">norm_dist_from_center</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sup_fixator</span><span class="p">,</span> <span class="s1">&#39;norm_dist_from_center&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">area</span> <span class="ow">in</span> <span class="n">areas</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;train&#39;</span> <span class="k">if</span> <span class="n">training</span> <span class="k">else</span> <span class="s1">&#39;val&#39;</span>
            <span class="n">max_fixations_to_use</span> <span class="o">=</span> <span class="n">max_fixations</span>
            <span class="n">norm_dist_from_center_to_use</span> <span class="o">=</span> <span class="n">norm_dist_from_center</span>
            <span class="k">if</span> <span class="n">norm_dist_from_center_to_use</span> <span class="o">!=</span> <span class="s1">&#39;original&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sup_fixator</span><span class="o">.</span><span class="n">norm_dist_from_center</span> <span class="o">=</span> <span class="n">norm_dist_from_center_to_use</span>
            <span class="n">dtag</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_normdist-</span><span class="si">{</span><span class="n">norm_dist_from_center_to_use</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">norm_dist_from_center_to_use</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">acc_fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">SLOW_DIR</span><span class="si">}</span><span class="s1">/accuracy/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">cfg_dict_flat</span><span class="p">[</span><span class="s2">&quot;logging.base_fn&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/area-</span><span class="si">{</span><span class="n">area</span><span class="si">}</span><span class="s1">_maxfix-</span><span class="si">{</span><span class="n">max_fixations_to_use</span><span class="si">}{</span><span class="n">dtag</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s1">.pkl&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">acc_fn</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite_accuracy</span> <span class="ow">and</span> <span class="n">max_batches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">acc</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">acc_fn</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">activations</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">compute_activations</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="n">loader</span><span class="p">,</span> <span class="n">area_range</span><span class="o">=</span><span class="p">[</span><span class="n">area</span><span class="p">,</span> <span class="n">area</span><span class="p">],</span> <span class="n">n_fixations</span><span class="o">=</span><span class="n">max_fixations_to_use</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># computed accuracy aggregated up until each fixation</span>
                <span class="n">acc</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">activations</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="n">layer_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n_fixations</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">min_fixations</span><span class="p">,</span> <span class="n">max_fixations_to_use</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># select up to n_fixations</span>
                    <span class="n">these_activations</span> <span class="o">=</span> <span class="n">activations</span><span class="p">[:,:</span><span class="n">n_fixations</span><span class="p">]</span>
                    <span class="k">with</span> <span class="n">autocast</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">amp_dtype</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">use_amp</span><span class="p">),</span> <span class="n">device_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">device</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">probe_layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">these_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">probes</span><span class="o">.</span><span class="n">probes</span><span class="p">[</span><span class="n">probe_layer</span><span class="p">](</span><span class="n">these_activations</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">these_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">these_activations</span><span class="p">)</span>
                        <span class="n">these_outputs</span> <span class="o">=</span> <span class="n">these_outputs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="n">acc</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">these_outputs</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">max_batches</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cache_accuracy</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">acc_fn</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">acc_fn</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            
            <span class="n">all_accs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;area = </span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">area</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc</span>

        <span class="c1"># plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">area</span><span class="p">,</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">all_accs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_fixations</span><span class="p">,</span> <span class="n">max_fixations</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">acc</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;MultiRandom (</span><span class="si">{</span><span class="n">area</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;# of fixations&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Aggregated accuracy&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_fixations</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;multi_fixation_accuracy.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;n_fixations&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;acc&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">area</span> <span class="ow">in</span> <span class="n">all_accs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">n_fixations</span><span class="p">,</span> <span class="n">acc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_accs</span><span class="p">[</span><span class="n">area</span><span class="p">]):</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;n_fixations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_fixations</span> <span class="o">+</span> <span class="n">n_fixations</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;acc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># restore original norm_dist_from_center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sup_fixator</span><span class="o">.</span><span class="n">norm_dist_from_center</span> <span class="o">=</span> <span class="n">nd_from_center_orig</span>

        <span class="k">return</span> <span class="n">df</span> </div>


<div class="viewcode-block" id="Visualizer.visualize_filters">
<a class="viewcode-back" href="../../api/foveation.visualizer.html#foveation.visualizer.Visualizer.visualize_filters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        
        <span class="c1"># first_layer_weights = layer.conv.weight</span>
        <span class="n">layer</span><span class="p">,</span> <span class="n">first_layer_weights</span> <span class="o">=</span> <span class="n">get_first_conv_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">backbone</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">ref_coords</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">first_layer_weights</span> <span class="o">=</span> <span class="n">first_layer_weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">first_layer_weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">visualize_filters_knn</span><span class="p">(</span><span class="n">first_layer_weights</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="mi">8</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">channel_mult</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">base_fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;filters&#39;</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_fn</span><span class="si">}</span><span class="s1">.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">base_fn</span></div>

        
<div class="viewcode-block" id="Visualizer.visualize_filter">
<a class="viewcode-back" href="../../api/foveation.visualizer.html#foveation.visualizer.Visualizer.visualize_filter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">axis_off</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">layer</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">get_first_conv_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">backbone</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">ref_coords</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

        <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span> <span class="o">-</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">upper_bound</span> <span class="o">-</span> <span class="n">lower_bound</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axis_off</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        <span class="c1"># plt.tight_layout()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;filter-</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>

    
<div class="viewcode-block" id="Visualizer.visualize_filter_over_space">
<a class="viewcode-back" href="../../api/foveation.visualizer.html#foveation.visualizer.Visualizer.visualize_filter_over_space">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_filter_over_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_locs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s_coords</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">coords_alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">rf_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
        <span class="n">layer</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">get_first_conv_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">backbone</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">ref_coords</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">local_rf</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">local_rf</span>

        <span class="n">reweighted_conv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nkv,dvc-&gt;ndkc&#39;</span><span class="p">,</span> <span class="n">local_rf</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">knn_indices</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">knn_indices</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">knn_mask</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">knn_indices_pad_mask</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        
        <span class="n">polar_coords</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">out_coords</span><span class="o">.</span><span class="n">polar</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="c1"># Find units at polar angle = 0</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unit_inds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">angle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
                <span class="n">zero_angle_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">polar_coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">angle</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="n">zero_angle_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">zero_angle_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Get their radii</span>
                <span class="n">zero_angle_radii</span> <span class="o">=</span> <span class="n">polar_coords</span><span class="p">[</span><span class="n">zero_angle_inds</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Take evenly spaced samples over the radius range</span>
                <span class="n">radius_min</span><span class="p">,</span> <span class="n">radius_max</span> <span class="o">=</span> <span class="n">zero_angle_radii</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">zero_angle_radii</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">target_radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.2</span><span class="o">*</span><span class="n">radius_min</span><span class="p">,</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">radius_max</span><span class="p">,</span> <span class="n">num_locs</span><span class="p">)</span>
                <span class="c1"># Find closest points to target radii</span>
                <span class="n">sample_inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zero_angle_radii</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">target_radii</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ii</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># drop the central unit for the second angle</span>
                    <span class="n">sample_inds</span> <span class="o">=</span> <span class="n">sample_inds</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">unit_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zero_angle_inds</span><span class="p">[</span><span class="n">sample_inds</span><span class="p">])</span>
            <span class="n">unit_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">unit_inds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unit_inds</span> <span class="o">=</span> <span class="n">units</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">unit_inds</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">]},</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">out_coords</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">in_coords</span><span class="o">.</span><span class="n">cartesian</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">in_coords</span><span class="o">.</span><span class="n">plotting</span><span class="p">],</span> <span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">out_coords</span><span class="o">.</span><span class="n">cartesian</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">out_coords</span><span class="o">.</span><span class="n">plotting</span><span class="p">]):</span>
            <span class="n">flip_y</span> <span class="o">=</span>  <span class="n">torch</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">in_coords</span><span class="o">.</span><span class="n">plotting</span><span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">flip_y</span><span class="p">:</span>
                <span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">s_coords</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">coords_alpha</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">unit_inds</span><span class="p">:</span>
                <span class="n">all_locs</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">reweighted_conv</span><span class="p">[:,</span><span class="nb">filter</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">all_locs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">rf_indices</span> <span class="o">=</span> <span class="n">knn_indices</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">knn_mask</span><span class="p">[:,</span><span class="n">ii</span><span class="p">])</span>
                <span class="n">rf_indices</span> <span class="o">=</span> <span class="n">rf_indices</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">rf_coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">rf_indices</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rf_coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">rf_coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">rf_alpha</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rf_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">rf_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;filter-</span><span class="si">{</span><span class="nb">filter</span><span class="si">}</span><span class="s1">_over_space.png&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="c1"># too wasteful as a pdf</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="Visualizer.plot_coordinates">
<a class="viewcode-back" href="../../api/foveation.visualizer.html#foveation.visualizer.Visualizer.plot_coordinates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_layer-</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">out_coords</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">plot_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">out_coords</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">retinal_transform</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">plot_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">retinal_transform</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">plot_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

        <span class="c1"># First column</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

        <span class="c1"># Second column</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">plot_coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">plot_coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;coordinates</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>        </div>


<div class="viewcode-block" id="Visualizer.plot_spatial_rf_from_multi_layers">
<a class="viewcode-back" href="../../api/foveation.visualizer.html#foveation.visualizer.Visualizer.plot_spatial_rf_from_multi_layers">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_spatial_rf_from_multi_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_layer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_layer</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">theta</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">plot_hex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hex_grid_size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vmax_percentile</span><span class="o">=</span><span class="mi">40</span><span class="p">):</span>
        <span class="n">plot_layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">knn_indices_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">KNNBaseLayer</span><span class="p">):</span>
                    <span class="n">plot_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
                    <span class="n">knn_indices_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">knn_indices_pad_token</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

        <span class="n">base_coords</span> <span class="o">=</span> <span class="n">plot_layers</span><span class="p">[</span><span class="n">plot_layer</span><span class="p">]</span><span class="o">.</span><span class="n">in_coords</span><span class="o">.</span><span class="n">cartesian</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_layer</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">((</span><span class="n">max_layer</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_layers</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ii</span> <span class="o">&gt;</span> <span class="n">max_layer</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">in_coords</span> <span class="o">=</span> <span class="n">plot_layers</span><span class="p">[</span><span class="n">plot_layer</span><span class="p">]</span><span class="o">.</span><span class="n">in_coords</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">in_polar_coords</span> <span class="o">=</span> <span class="n">plot_layers</span><span class="p">[</span><span class="n">plot_layer</span><span class="p">]</span><span class="o">.</span><span class="n">in_coords</span><span class="o">.</span><span class="n">polar</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> 
            <span class="n">in_cortex_coords</span> <span class="o">=</span> <span class="n">plot_layers</span><span class="p">[</span><span class="n">plot_layer</span><span class="p">]</span><span class="o">.</span><span class="n">in_coords</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            
            <span class="n">out_coords</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">out_coords</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">out_polar_coords</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">out_coords</span><span class="o">.</span><span class="n">polar</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">out_cortex_coords</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">out_coords</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">cart_size</span> <span class="o">=</span> <span class="n">in_polar_coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span>
            
            <span class="n">unit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">out_polar_coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">out_polar_coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">-</span> <span class="n">theta</span><span class="p">))</span>
            <span class="n">unit_coords</span> <span class="o">=</span> <span class="n">out_coords</span><span class="p">[</span><span class="n">unit</span><span class="p">,:]</span>
            <span class="n">unit_cortex_coords</span> <span class="o">=</span> <span class="n">out_cortex_coords</span><span class="p">[</span><span class="n">unit</span><span class="p">,:]</span>
            <span class="n">rf</span> <span class="o">=</span> <span class="n">compute_receptive_field</span><span class="p">(</span><span class="n">knn_indices_list</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">in_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plot_layer</span><span class="o">=</span><span class="n">plot_layer</span><span class="p">)</span>
            <span class="n">rf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">rf</span><span class="p">[</span><span class="n">rf</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax_percentile</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">plot_hex</span><span class="p">:</span>
                <span class="n">scatter</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">hexbin</span><span class="p">(</span><span class="n">base_coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">base_coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">C</span><span class="o">=</span><span class="n">rf</span><span class="p">,</span> <span class="n">gridsize</span><span class="o">=</span><span class="n">hex_grid_size</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scatter</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">in_coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">in_coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">cart_size</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">rf</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">],</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">unit_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unit_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Layer </span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plot_hex</span><span class="p">:</span>
                <span class="n">scatter</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">hexbin</span><span class="p">(</span><span class="n">in_cortex_coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">in_cortex_coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">C</span><span class="o">=</span><span class="n">rf</span><span class="p">,</span> <span class="n">gridsize</span><span class="o">=</span><span class="n">hex_grid_size</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scatter</span> <span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">in_cortex_coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">in_cortex_coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">rf</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">unit_cortex_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unit_cortex_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
            <span class="c1"># add colorbar</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">],</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Layer </span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">h_tag</span> <span class="o">=</span> <span class="s1">&#39;_hex&#39;</span> <span class="k">if</span> <span class="n">plot_hex</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">out_type</span> <span class="o">=</span> <span class="s1">&#39;pdf&#39;</span> <span class="k">if</span> <span class="n">plot_hex</span> <span class="k">else</span> <span class="s1">&#39;png&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;spatialrf_layer-</span><span class="si">{</span><span class="n">plot_layer</span><span class="si">}</span><span class="s1">_from-</span><span class="si">{</span><span class="n">max_layer</span><span class="si">}</span><span class="s1">_layers</span><span class="si">{</span><span class="n">h_tag</span><span class="si">}</span><span class="s1">_vmaxp-</span><span class="si">{</span><span class="n">vmax_percentile</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">out_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Visualizer.plot_sampling_grids">
<a class="viewcode-back" href="../../api/foveation.visualizer.html#foveation.visualizer.Visualizer.plot_sampling_grids">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_sampling_grids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha_layer0</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">),</span> <span class="mi">6</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">layer_ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">layer_ind</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">retinal_transform</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">plotting_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">retinal_transform</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_ind</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">out_coords</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">plotting_coords</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">out_coords</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">sqrt_coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mf">.5</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;layer </span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s1"> has </span><span class="si">{</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> coordinates (</span><span class="si">{</span><span class="n">sqrt_coords</span><span class="si">}</span><span class="s1"> x </span><span class="si">{</span><span class="n">sqrt_coords</span><span class="si">}</span><span class="s1"> equivalent)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span> <span class="k">if</span> <span class="n">ii</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">alpha_layer0</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">plotting_coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">plotting_coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span> <span class="k">if</span> <span class="n">ii</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">alpha_layer0</span><span class="p">)</span>
            <span class="c1"># axs[0,ii].axis(&#39;equal&#39;)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Layer </span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sampling_grids.png&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="Visualizer.plot_rf_diameters">
<a class="viewcode-back" href="../../api/foveation.visualizer.html#foveation.visualizer.Visualizer.plot_rf_diameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_rf_diameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_eccentricity_factor</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">cividis</span><span class="p">):</span>
        <span class="n">size_df</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;eccentricity&#39;</span><span class="p">:[],</span> <span class="s1">&#39;diameter&#39;</span><span class="p">:[],</span> <span class="s1">&#39;layer&#39;</span><span class="p">:[],</span> <span class="s1">&#39;layer_type&#39;</span><span class="p">:[],</span> <span class="s1">&#39;layer_name&#39;</span><span class="p">:[]}</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">retinal_transform</span><span class="o">.</span><span class="n">fov</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">max_eccentricity</span> <span class="o">=</span> <span class="n">fov</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">max_eccentricity_factor</span><span class="p">)</span>

        <span class="n">conv_ind</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">pool_ind</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">knn_layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">KNNBaseLayer</span><span class="p">)]</span>

        <span class="n">knn_indices_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">knn_indices_pad_token</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">knn_layers</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">max_layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_layer</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">knn_layers</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">max_layer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">max_layer</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">knn_layers</span><span class="p">)</span> <span class="o">+</span> <span class="n">max_layer</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_layer</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">knn_layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">out_coords</span><span class="p">)):</span>
                <span class="n">rf</span> <span class="o">=</span> <span class="n">compute_binary_receptive_field</span><span class="p">(</span><span class="n">knn_indices_list</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">in_coords</span><span class="p">),</span> <span class="n">plot_layer</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">in_coords</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">rf_coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">rf</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">]</span>
                <span class="n">diameter</span> <span class="o">=</span> <span class="p">((</span><span class="n">rf_coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">rf_coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">+</span> <span class="p">(</span><span class="n">rf_coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">rf_coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">eccentricity</span> <span class="o">=</span> <span class="n">knn_layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">out_coords</span><span class="o">.</span><span class="n">polar</span><span class="p">[</span><span class="n">unit</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">size_df</span><span class="p">[</span><span class="s1">&#39;eccentricity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eccentricity</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">fov</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">size_df</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diameter</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">fov</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">size_df</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
                <span class="n">layer_type</span> <span class="o">=</span> <span class="s1">&#39;KNNConv&#39;</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">knn_layers</span><span class="p">[</span><span class="n">layer</span><span class="p">],</span> <span class="s1">&#39;ref_coords&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;Pool&#39;</span>
                <span class="n">size_df</span><span class="p">[</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer_type</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">layer_type</span> <span class="o">==</span> <span class="s1">&#39;KNNConv&#39;</span><span class="p">:</span>
                    <span class="n">size_df</span><span class="p">[</span><span class="s1">&#39;layer_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;KNNConv_</span><span class="si">{</span><span class="n">conv_ind</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">conv_ind</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">size_df</span><span class="p">[</span><span class="s1">&#39;layer_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pool_</span><span class="si">{</span><span class="n">pool_ind</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">pool_ind</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">size_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">size_df</span><span class="p">)</span>
            
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>

        <span class="c1"># Create a custom color palette that matches the colorbar we&#39;ll create</span>
        <span class="n">n_layers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_layer</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">size_df</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
        <span class="n">palette</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">))</span>

        <span class="c1"># Use seaborn for the plots with our custom palette</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">size_df</span><span class="p">[</span><span class="n">size_df</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_layer</span><span class="p">],</span> 
                        <span class="n">x</span><span class="o">=</span><span class="s1">&#39;eccentricity&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;diameter&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;layer_type&#39;</span><span class="p">,</span>
                        <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">size_df</span><span class="p">[</span><span class="n">size_df</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_layer</span><span class="p">],</span> 
                    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;eccentricity&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;diameter&#39;</span><span class="p">,</span> 
                    <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="o">*</span><span class="n">max_eccentricity</span><span class="p">,</span> <span class="n">max_eccentricity</span><span class="p">)</span>
        <span class="c1"># plt.axhline(y=fov, color=&#39;black&#39;, linestyle=&#39;--&#39;, alpha=0.5)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">fov</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;fov = </span><span class="si">{</span><span class="n">fov</span><span class="si">}</span><span class="s1"> deg&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fov</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;RF diameter (deg)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Eccentricity (deg)&#39;</span><span class="p">)</span>

        <span class="c1"># Add a colorbar instead of a legend</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_layer</span><span class="p">)</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
        <span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Layer&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_layer</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>    

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;rf_diameters.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

                    
<div class="viewcode-block" id="Visualizer.print_all_functions">
<a class="viewcode-back" href="../../api/foveation.visualizer.html#foveation.visualizer.Visualizer.print_all_functions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_all_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;print_all_functions&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="get_first_conv_weights">
<a class="viewcode-back" href="../../api/foveation.visualizer.html#foveation.visualizer.get_first_conv_weights">[docs]</a>
<span class="nd">@add_to_all</span><span class="p">(</span><span class="n">__all__</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_first_conv_weights</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the weights of the first convolutional layer in an arbitrary CNN.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (nn.Module): The CNN model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Weights of the first convolutional layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Recursively traverse the model&#39;s layers</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_children</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
            <span class="c1"># Return the weights of the first Conv2d layer found</span>
            <span class="k">return</span> <span class="n">layer</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">weight</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">KNNConvLayer</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">layer</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">weight</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If the layer is a container (e.g., Sequential, ModuleList), recurse into it</span>
            <span class="n">layer</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">get_first_conv_weights</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">layer</span><span class="p">,</span> <span class="n">weights</span>
    <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Return None if no Conv2d layer is found</span></div>



<div class="viewcode-block" id="visualize_filters">
<a class="viewcode-back" href="../../api/foveation.visualizer.html#foveation.visualizer.visualize_filters">[docs]</a>
<span class="nd">@add_to_all</span><span class="p">(</span><span class="n">__all__</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">visualize_filters</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize convolutional filters from the first layer of a neural network.</span>

<span class="sd">    This function creates a grid of images, each representing a single filter</span>
<span class="sd">    from the first convolutional layer. The filters are normalized to the range</span>
<span class="sd">    [0, 1] for better visibility.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    weights : torch.Tensor</span>
<span class="sd">        A tensor of shape (num_filters, channels, height, width) containing</span>
<span class="sd">        the weights of the first convolutional layer.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    fig : matplotlib.figure.Figure</span>
<span class="sd">        The figure object containing the visualized filters.</span>
<span class="sd">    ax : matplotlib.axes.Axes</span>
<span class="sd">        The last axes object used in the grid (mainly for compatibility with</span>
<span class="sd">        existing return statement).</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    The function assumes that the input weights are from the first</span>
<span class="sd">    convolutional layer and have a 3D structure (channels, height, width)</span>
<span class="sd">    for each filter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">ImageGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">nrows</span><span class="p">),</span> <span class="n">axes_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="c1"># robustly normalize to 0-1</span>
    <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span> <span class="o">-</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">upper_bound</span> <span class="o">-</span> <span class="n">lower_bound</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ii</span> <span class="o">&gt;</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>



<div class="viewcode-block" id="visualize_filters_knn">
<a class="viewcode-back" href="../../api/foveation.visualizer.html#foveation.visualizer.visualize_filters_knn">[docs]</a>
<span class="nd">@add_to_all</span><span class="p">(</span><span class="n">__all__</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">visualize_filters_knn</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize convolutional filters from the first layer of a neural network.</span>

<span class="sd">    This function creates a grid of images, each representing a single filter</span>
<span class="sd">    from the first convolutional layer. The filters are normalized to the range</span>
<span class="sd">    [0, 1] for better visibility.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    weights : torch.Tensor</span>
<span class="sd">        A tensor of shape (num_filters, channels, num_coords) containing</span>
<span class="sd">        the weights of the first convolutional layer.</span>
<span class="sd">    coords : torch.Tensor</span>
<span class="sd">        A tensor of shape (num_coords, 2) containing the coordinates of the points.</span>
<span class="sd">    kwargs: dict</span>
<span class="sd">        Additional keyword arguments for the scatter plot.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    fig : matplotlib.figure.Figure</span>
<span class="sd">        The figure object containing the visualized filters.</span>
<span class="sd">    ax : matplotlib.axes.Axes</span>
<span class="sd">        The last axes object used in the grid (mainly for compatibility with</span>
<span class="sd">        existing return statement).</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    The function assumes that the input weights are from the first</span>
<span class="sd">    convolutional layer and have a 3D structure (channels, height, width)</span>
<span class="sd">    for each filter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figsize</span><span class="p">,</span><span class="n">figsize</span><span class="p">))</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">ImageGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">nrows</span><span class="p">),</span> <span class="n">axes_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="c1"># robustly normalize to 0-1</span>
    <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span> <span class="o">-</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">upper_bound</span> <span class="o">-</span> <span class="n">lower_bound</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ii</span> <span class="o">&gt;</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">these_weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># normalize to 0-1 at the single kernel level</span>
        <span class="c1"># these_weights = (these_weights - these_weights.min()) / (these_weights.max() - these_weights.min())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">these_weights</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>