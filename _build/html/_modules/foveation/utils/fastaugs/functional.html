

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>foveation.utils.fastaugs.functional &mdash; foveation 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            foveation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../read_me.html">A biologically-inspired foveated interface for deep vision models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Quickstart</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core Components</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/foveation.sensing.html">foveation.sensing package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/foveation.arch.html">foveation.arch package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/foveation.saccadenet.html">foveation.saccadenet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/foveation.trainer.html">foveation.trainer</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Utilities &amp; Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/foveation.utils.html">foveation.utils package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/foveation.demo.html">foveation.demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/foveation.paths.html">foveation.paths</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/foveation.probes.html">foveation.probes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/foveation.visualizer.html">foveation.visualizer</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">foveation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../foveation.html">foveation</a></li>
          <li class="breadcrumb-item"><a href="../../utils.html">foveation.utils</a></li>
      <li class="breadcrumb-item active">foveation.utils.fastaugs.functional</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for foveation.utils.fastaugs.functional</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">radians</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision</span><span class="w"> </span><span class="kn">import</span> <span class="n">transforms</span> <span class="k">as</span> <span class="n">tv_transforms</span> 

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">fastcore.dispatch</span><span class="w"> </span><span class="kn">import</span> <span class="n">typedispatch</span>
<span class="k">except</span><span class="p">:</span>
    <span class="c1"># https://answerdotai.github.io/fasttransform/fastcore_migration_guide.html</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">plum</span><span class="w"> </span><span class="kn">import</span> <span class="n">dispatch</span> <span class="k">as</span> <span class="n">typedispatch</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">PIL</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageEnhance</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.core.debugger</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_trace</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
    
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">torch._six</span><span class="w"> </span><span class="kn">import</span> <span class="n">container_abcs</span>
<span class="k">except</span><span class="p">:</span>
    <span class="c1"># some issue with torch v1.9</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">container_abcs</span>     

<span class="n">default_device</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span>

<span class="c1"># =================================================</span>
<span class="c1">#  used to randomly determine which images to transform</span>
<span class="c1"># =================================================</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mask_batch</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>  
    <span class="n">do</span> <span class="o">=</span> <span class="n">mask_tensor</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">new_ones</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">do</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">do</span><span class="p">,</span><span class="n">idx</span>

<div class="viewcode-block" id="mask_batch">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.mask_batch">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mask_batch</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>        
    <span class="n">do</span> <span class="o">=</span> <span class="n">mask_tensor</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">do</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">do</span><span class="p">,</span><span class="n">idx</span></div>


<div class="viewcode-block" id="mask_tensor">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.mask_tensor">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mask_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">neutral</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Mask elements of `x` with `neutral` with probability `1-p`</span>
<span class="sd">        modified from https://github.com/fastai/fastai2/blob/master/fastai2/vision/augment.py</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">==</span><span class="mf">1.</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="n">neutral</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="o">-</span><span class="n">neutral</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">new_empty</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">())</span><span class="o">.</span><span class="n">bernoulli_</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
    <span class="n">x</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">neutral</span><span class="p">)</span> <span class="k">if</span> <span class="n">neutral</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">x</span></div>


<span class="c1"># =================================================</span>
<span class="c1">#  normalize</span>
<span class="c1"># =================================================</span>

<span class="c1"># def channels_first(x):</span>
<span class="c1">#     if len(x.shape) == 4 and x.shape[1] == 3 and not x.shape[3] == 3:</span>
<span class="c1">#         return True</span>
<span class="c1">#     if len(x.shape) == 4 and x.shape[1] == 3 and not x.shape[3] == 3:</span>
        
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">normalize</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">):</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">-=</span> <span class="n">mean</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">*=</span> <span class="n">denominator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">-=</span> <span class="n">mean</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">*=</span> <span class="n">denominator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unsupported shape, expected 3 or 4 dimensions, got: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">x</span>

<div class="viewcode-block" id="normalize">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.normalize">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">normalize</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">x</span><span class="o">.</span><span class="n">sub_</span><span class="p">(</span><span class="n">mean</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">div_</span><span class="p">(</span><span class="n">std</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">x</span><span class="o">.</span><span class="n">sub_</span><span class="p">(</span><span class="n">mean</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">div_</span><span class="p">(</span><span class="n">std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unsupported shape, expected 3 or 4 dimensions, got: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">x</span></div>


<span class="c1"># =================================================</span>
<span class="c1">#  to_device</span>
<span class="c1"># =================================================</span>

<div class="viewcode-block" id="to_device">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.to_device">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">to_device</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Move tensor to device&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">container_abcs</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>    
        <span class="k">return</span> <span class="p">[</span><span class="n">to_device</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unsupported type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

        
<span class="c1"># =================================================</span>
<span class="c1">#  to_numpy</span>
<span class="c1"># =================================================</span>

<div class="viewcode-block" id="to_numpy">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.to_numpy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">to_numpy</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Convert tensor to numpy array&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">container_abcs</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>    
        <span class="k">return</span> <span class="p">[</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unsupported type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

        
<span class="c1"># =================================================</span>
<span class="c1">#  to_float</span>
<span class="c1"># =================================================</span>

<div class="viewcode-block" id="to_float">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.to_float">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">to_float</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Convert tensor to float&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">container_abcs</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>    
        <span class="k">return</span> <span class="p">[</span><span class="n">to_float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unsupported type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

        
<span class="c1"># =================================================</span>
<span class="c1">#  div_ (another way of converting tensor to float, </span>
<span class="c1">#  seems faster than .float())</span>
<span class="c1"># =================================================</span>

<div class="viewcode-block" id="div_">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.div_">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">div_</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">255.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">container_abcs</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>    
        <span class="k">return</span> <span class="p">[</span><span class="n">div_</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">samples</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unsupported type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

    
<span class="c1"># =================================================</span>
<span class="c1">#  to_channels_first, to_channels_last</span>
<span class="c1"># =================================================</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">to_channels_first</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># from NHWC to NCHW</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># from HWC to CHW</span>
    
    <span class="k">return</span> <span class="n">x</span>

<div class="viewcode-block" id="to_channels_first">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.to_channels_first">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">to_channels_first</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bijk-&gt;bkij&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>        
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk-&gt;kij&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>


<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">to_channels_last</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># from NCHW [0,1,2,3] to NHWC [0,2,3,1]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># from CHW [0,1,2] to HWC [1,2,0]</span>
    
    <span class="k">return</span> <span class="n">x</span>

<div class="viewcode-block" id="to_channels_last">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.to_channels_last">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">to_channels_last</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bkij-&gt;bijk&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>        
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kij-&gt;ijk&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>


<span class="c1"># =================================================</span>
<span class="c1">#  TO_GRAYSCALE</span>
<span class="c1"># =================================================</span>

<span class="c1"># grayscale = torch.tensor([(299/1000), (587/1000), (114/1000)])[:,None,None]</span>
<span class="n">grayscale</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.2989</span><span class="p">,</span> <span class="mf">0.5870</span><span class="p">,</span> <span class="mf">0.1140</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">random_grayscale</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">num_output_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Convert random set of images in batch `b` to grayscale using ITU-R 601-2 luma transform&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># single image</span>
        <span class="n">do</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>
        <span class="k">return</span> <span class="n">to_grayscale</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">num_output_channels</span><span class="o">=</span><span class="n">num_output_channels</span><span class="p">)</span> <span class="k">if</span> <span class="n">do</span> <span class="k">else</span> <span class="n">b</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># mini-batch</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">index_copy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">to_grayscale</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="n">num_output_channels</span><span class="o">=</span><span class="n">num_output_channels</span><span class="p">))</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">random_grayscale</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">num_output_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Convert random set of images in batch `b` to grayscale using ITU-R 601-2 luma transform&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># single image</span>
        <span class="n">do</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>
        <span class="k">return</span> <span class="n">to_grayscale</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">num_output_channels</span><span class="o">=</span><span class="n">num_output_channels</span><span class="p">)</span> <span class="k">if</span> <span class="n">do</span> <span class="k">else</span> <span class="n">b</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># mini-batch</span>
        <span class="n">b</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_grayscale</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">num_output_channels</span><span class="o">=</span><span class="n">num_output_channels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">b</span>

<div class="viewcode-block" id="random_grayscale">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.random_grayscale">[docs]</a>
<span class="nd">@typedispatch</span>    
<span class="k">def</span><span class="w"> </span><span class="nf">random_grayscale</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span> 
    <span class="c1"># could implement for numpy using</span>
    <span class="c1"># numpy.take(a, indices, axis=None</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

    
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">to_grayscale</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">num_output_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Convert to grayscale like PIL, using ITU-R 601-2 luma transform</span>
<span class="sd">        L = R * 299/1000 + G * 587/1000 + B * 114/1000</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># batch on gpu</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="c1"># grayscale = torch.tensor([0.299, 0.587, 0.114])[:,None,None].to(&#39;cuda&#39;)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">grayscale</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:,:]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_output_channels</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> 
            <span class="n">L</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="n">L</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># batch on cpu</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;cpu&#39;</span><span class="p">:</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="mf">0.299</span> <span class="o">+</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="mf">0.587</span> <span class="o">+</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="mf">0.114</span>
        <span class="k">if</span> <span class="n">num_output_channels</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> 
            <span class="n">L</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="n">L</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># single image on gpu</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="c1"># grayscale = torch.tensor([0.299, 0.587, 0.114])[:,None,None].to(&#39;cuda&#39;)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">grayscale</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_output_channels</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> 
            <span class="n">L</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="n">L</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># single image on cpu</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;cpu&#39;</span><span class="p">:</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="mf">0.299</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="mf">0.587</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="mf">0.114</span>
        <span class="k">if</span> <span class="n">num_output_channels</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> 
            <span class="n">L</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="n">L</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">L</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">to_grayscale</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">num_output_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Convert to grayscale like PIL, using ITU-R 601-2 luma transform</span>
<span class="sd">        L = R * 299/1000 + G * 587/1000 + B * 114/1000</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">299</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="p">[:,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">587</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="p">[:,:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">114</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_output_channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">L</span>
        <span class="k">elif</span> <span class="n">num_output_channels</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">L</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;num_output_channels should be either 1 or 3&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">299</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">587</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">114</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_output_channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">L</span>
        <span class="k">elif</span> <span class="n">num_output_channels</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">L</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;num_output_channels should be either 1 or 3&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<div class="viewcode-block" id="to_grayscale">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.to_grayscale">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">to_grayscale</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">num_output_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Convert to grayscale like PIL, using ITU-R 601-2 luma transform</span>
<span class="sd">        L = R * 299/1000 + G * 587/1000 + B * 114/1000</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;to_grayscale&#39;</span><span class="p">,</span> <span class="s1">&#39;PIL.Image&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">num_output_channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">num_output_channels</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;num_output_channels should be either 1 or 3&#39;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">x</span></div>


<span class="c1"># =================================================</span>
<span class="c1">#  COLOR JITTER</span>
<span class="c1"># http://beesbuzz.biz/code/16-hsv-color-transforms</span>
<span class="c1"># https://stackoverflow.com/questions/8507885/shift-hue-of-an-rgb-color</span>
<span class="c1"># https://github.com/NVIDIA/DALI/blob/5b9f9d72056239bcc7df9daa1626a9fe34af7e43/dali/operators/image/color/hsv.h</span>
<span class="c1"># - map RGB to YIQ space</span>
<span class="c1"># - rotate around the Y channel by &quot;roate_hue&quot;</span>
<span class="c1"># - multiplying the color channels (I, Q) by &quot;scale_saturation&quot;</span>
<span class="c1"># - multiply all channels (Y, I, Q) by &quot;scale_value&quot;</span>
<span class="c1"># - map YIQ to RGB</span>
<span class="c1"># - these are all linear transforms that can be computed with one transform matrix</span>
<span class="c1"># </span>
<span class="c1"># Following color_twist, we can more closely emulate torchvision color_jitter</span>
<span class="c1"># https://github.com/NVIDIA/DALI/blob/1031314b7857ec11d40e31496089579297a2e863/dali/operators/image/color/color_twist.h</span>
<span class="c1"># =================================================</span>

<span class="n">M_PI</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>

<span class="n">Rgb2Yiq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mf">.299</span><span class="p">,</span> <span class="mf">.587</span><span class="p">,</span> <span class="mf">.114</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">.596</span><span class="p">,</span> <span class="o">-</span><span class="mf">.274</span><span class="p">,</span> <span class="o">-</span><span class="mf">.321</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">.211</span><span class="p">,</span> <span class="o">-</span><span class="mf">.523</span><span class="p">,</span> <span class="mf">.311</span><span class="p">]])</span>

<span class="n">Yiq2Rgb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">.956</span><span class="p">,</span> <span class="mf">.621</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">.272</span><span class="p">,</span> <span class="o">-</span><span class="mf">.647</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.107</span><span class="p">,</span> <span class="mf">1.705</span><span class="p">]])</span>

<div class="viewcode-block" id="dummy_red">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.dummy_red">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">dummy_red</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;test generating batch of red squares&#39;&#39;&#39;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">bs</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">s</span><span class="p">)),</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">bs</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">s</span><span class="p">)),</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">bs</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>
    <span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="mat3">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.mat3">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mat3</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Identity matrix with given value&#39;&#39;&#39;</span>
    <span class="c1"># In the YIQ color space, value change is a</span>
    <span class="c1"># uniform scaling across all dimensions</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">*</span> <span class="n">value</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="hue_mat">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.hue_mat">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">hue_mat</span><span class="p">(</span><span class="n">hue</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Composes transformation matrix for hue&#39;&#39;&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hue</span><span class="p">)</span>
    <span class="n">h_rad</span> <span class="o">=</span> <span class="n">hue</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">M_PI</span><span class="p">)</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">hue</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Hue change in YIQ color space is a rotation along the Y axis</span>
    <span class="n">ret</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_rad</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span>
    <span class="n">ret</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_rad</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span>
    <span class="n">ret</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_rad</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
    <span class="n">ret</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">h_rad</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="sat_mat">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.sat_mat">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sat_mat</span><span class="p">(</span><span class="n">saturation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Composes transformation matrix for saturation&#39;&#39;&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">saturation</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">saturation</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># In the YIQ color space, saturation change is a</span>
    <span class="c1"># uniform scaling in IQ dimensions</span>
    <span class="n">ret</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">saturation</span>
    <span class="n">ret</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">saturation</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="val_mat">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.val_mat">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">val_mat</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Composes transformation matrix for value&#39;&#39;&#39;</span>
    <span class="c1"># In the YIQ color space, value change is scaling on first dimension</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ret</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="hsv_mat">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.hsv_mat">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">hsv_mat</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Composes transformation matrix for hue, sat, val transform over intermediate Yiq space&#39;&#39;&#39;</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">Yiq2Rgb</span> <span class="o">@</span> <span class="n">hue_mat</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">@</span> <span class="n">sat_mat</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">@</span> <span class="n">val_mat</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">@</span> <span class="n">Rgb2Yiq</span>
    <span class="k">return</span> <span class="n">mat</span></div>


<div class="viewcode-block" id="hsv_mat2">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.hsv_mat2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">hsv_mat2</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">brightness</span><span class="p">,</span><span class="n">contrast</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Composes transformation matrix for hue, sat, val transform over intermediate Yiq space&#39;&#39;&#39;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">device</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat3</span><span class="p">(</span><span class="n">brightness</span><span class="p">)</span> <span class="o">@</span> <span class="n">mat3</span><span class="p">(</span><span class="n">contrast</span><span class="p">)</span> <span class="o">@</span> <span class="n">Yiq2Rgb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="o">@</span> <span class="n">hue_mat</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">@</span> <span class="n">sat_mat</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">@</span> <span class="n">val_mat</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">@</span> <span class="n">Rgb2Yiq</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mat</span></div>

    
<span class="k">def</span><span class="w"> </span><span class="nf">_get_hsv_mat</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">h</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">h</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">h</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">s</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">s</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">v</span>        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">v</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="n">hue</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">sat</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">hsv_mat</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span><span class="n">sat</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">mat</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_get_hsv_mat2</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">h</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">h</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">h</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">s</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">s</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">v</span>        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">v</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">b</span>        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">b</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">c</span>        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">c</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="n">hue</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">sat</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">brightness</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">contrast</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">hsv_mat2</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span><span class="n">sat</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">brightness</span><span class="p">,</span><span class="n">contrast</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">mat</span>

<div class="viewcode-block" id="hsv_jitter_tensor">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.hsv_jitter_tensor">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">hsv_jitter_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># batch of images (x) AND same batch size for x and mat</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span> <span class="o">@</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
        <span class="c1"># batch of images (x) AND only one mat which we need to duplicate</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span> <span class="o">@</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
        <span class="c1"># single image (x) AND only one mat (we&#39;ll squueze off extra dimension)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">@</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="hsv_jitter_array">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.hsv_jitter_array">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">hsv_jitter_array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
    <span class="c1"># convert to channels first</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># batch of images (x) AND same batch size for x and mat</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bijk-&gt;bkij&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span> <span class="o">@</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bkij-&gt;bijk&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
        <span class="c1"># batch of images (x) AND only one mat which we need to duplicate</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bijk-&gt;bkij&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span> <span class="o">@</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bkij-&gt;bijk&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
        <span class="c1"># single image (x) AND only one mat (we&#39;ll squueze off extra dimension)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk-&gt;kij&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">@</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kij-&gt;ijk&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>        
    
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="hsv_jitter_array2">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.hsv_jitter_array2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">hsv_jitter_array2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
    <span class="c1"># convert to channels first</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># batch of images (x) AND same batch size for x and mat</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bijk-&gt;bkij&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span> <span class="o">@</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bkij-&gt;bijk&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
        <span class="c1"># batch of images (x) AND only one mat which we need to duplicate</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bijk-&gt;bkij&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span> <span class="o">@</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bkij-&gt;bijk&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
        <span class="c1"># single image (x) AND only one mat (we&#39;ll squueze off extra dimension)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk-&gt;kij&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">@</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kij-&gt;ijk&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>        
    
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="hsv_jitter">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.hsv_jitter">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">hsv_jitter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Performs hue, saturation, value transform on an RGB image with interediate Yiq transform    </span>
<span class="sd">        </span>
<span class="sd">        The RGB image can be a TensorImage with channels first (CxHxW; or a batch NxCxHxW), </span>
<span class="sd">        or an ArrayImage with channels last (HxWxC; or a batch NxHxWxC).</span>
<span class="sd">        </span>
<span class="sd">        Tensors are channels first because PyTorch/Torchvision operations assume so (though</span>
<span class="sd">        it looks like PyTorch 1.5 has a channels_last feature).</span>
<span class="sd">        </span>
<span class="sd">        Arrays are channels last so that this transformation can be used with the </span>
<span class="sd">        Albumentations library, which operates over numpy arrays with RGB channels last.</span>
<span class="sd">        </span>
<span class="sd">        inputs:</span>
<span class="sd">            x: RGB image [0-1] or batch of RGB images</span>
<span class="sd">            h: hue rotation angle in degrees (any angle, wraps at 360), or list of angles (one per image in batch)</span>
<span class="sd">            s: multiply saturation by this number, single value or list of values (one per image in batch)</span>
<span class="sd">            v: multiply value by this number, single value or list of values (one per image in batch)</span>
<span class="sd">        </span>
<span class="sd">        out: </span>
<span class="sd">            transformed RGB image (or batch of images images)</span>
<span class="sd">            clamped between 0,1 since Yiq values can be out of RGB range</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># get transformation matrix</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">_get_hsv_mat</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    
    <span class="c1"># multiply transformation matrix pixelwise</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">hsv_jitter_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">hsv_jitter_array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span></div>


<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">hsv_jitter2</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Performs hue, saturation, value transform on an RGB image with interediate Yiq transform    </span>
<span class="sd">        </span>
<span class="sd">        The RGB image can be a TensorImage with channels first (CxHxW; or a batch NxCxHxW), </span>
<span class="sd">        or an ArrayImage with channels last (HxWxC; or a batch NxHxWxC).</span>
<span class="sd">        </span>
<span class="sd">        Tensors are channels first because PyTorch/Torchvision operations assume so (though</span>
<span class="sd">        it looks like PyTorch 1.5 has a channels_last feature).</span>
<span class="sd">        </span>
<span class="sd">        Arrays are channels last so that this transformation can be used with the </span>
<span class="sd">        Albumentations library, which operates over numpy arrays with RGB channels last.</span>
<span class="sd">        </span>
<span class="sd">        inputs:</span>
<span class="sd">            x: RGB image [0-1] or batch of RGB images</span>
<span class="sd">            h: hue rotation angle in degrees (any angle, wraps at 360), or list of angles (one per image in batch)</span>
<span class="sd">            s: multiply saturation by this number, single value or list of values (one per image in batch)</span>
<span class="sd">            v: multiply value by this number, single value or list of values (one per image in batch)</span>
<span class="sd">            b: brightness jitter operates in RGB space</span>
<span class="sd">            c: contrast jitter</span>
<span class="sd">        out: </span>
<span class="sd">            transformed RGB image (or batch of images images)</span>
<span class="sd">            clamped between 0,1 since Yiq values can be out of RGB range</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># get transformation matrix combining hue, saturation, value, brightness, and contrast jitter</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">_get_hsv_mat2</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> 
    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    
    <span class="c1"># Get the image mean &amp; image offset for contrast adjustment</span>
    <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span> <span class="ow">or</span>  <span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Expected float, got </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">to_grayscale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_output_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="c1"># multiply transformation matrix pixelwise by image, plus contrast offset</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">hsv_jitter_tensor</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">mat</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="o">+</span> <span class="n">offset</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">hsv_jitter2</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">set_trace</span><span class="p">()</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">hsv_jitter_array2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        
<div class="viewcode-block" id="hsv_jitter2">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.hsv_jitter2">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">hsv_jitter2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unsupported type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">random_hsv_jitter2</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;randomly apply hsv jitter to each image in a batch&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># single image</span>
        <span class="n">do</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>
        <span class="k">return</span> <span class="n">hsv_jitter2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">do</span> <span class="k">else</span> <span class="n">x</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># mini-batch</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">index_copy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">hsv_jitter2</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>

<div class="viewcode-block" id="random_hsv_jitter2">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.random_hsv_jitter2">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">random_hsv_jitter2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unsupported type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>    </div>

    
<span class="c1"># =================================================</span>
<span class="c1">#  BRIGHTNESS</span>
<span class="c1"># =================================================</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_get_scale_factor</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">sf</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">sf</span><span class="p">):</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="p">[</span><span class="n">sf</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sf</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">sf</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">sf</span>
    
    <span class="n">sf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">sf</span>

<div class="viewcode-block" id="_get_scale_factor">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional._get_scale_factor">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_get_scale_factor</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sf</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">sf</span><span class="p">):</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sf</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="p">[</span><span class="n">sf</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sf</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">sf</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">*</span><span class="n">n</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">sf</span>
        
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span></div>


<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">adjust_brightness</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">255.</span><span class="p">):</span>
    
    <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">_get_scale_factor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">out</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">adjust_brightness</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">255.</span><span class="p">):</span>
    
    <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">_get_scale_factor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">out</span>

<div class="viewcode-block" id="adjust_brightness">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.adjust_brightness">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">adjust_brightness</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">255</span><span class="p">):</span>
    <span class="n">enhancer</span> <span class="o">=</span> <span class="n">ImageEnhance</span><span class="o">.</span><span class="n">Brightness</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">enhanced_im</span> <span class="o">=</span> <span class="n">enhancer</span><span class="o">.</span><span class="n">enhance</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">enhanced_im</span></div>

    
<div class="viewcode-block" id="adjust_brightness_pil">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.adjust_brightness_pil">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">adjust_brightness_pil</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">brightness</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">255.</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Adjust contrast like PIL ImageEnhance&#39;&#39;&#39;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">x</span> <span class="o">*</span> <span class="n">brightness</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="sigmoid">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.sigmoid">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span> </div>

    
<div class="viewcode-block" id="logit">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.logit">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">logit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">):</span>
    <span class="s2">&quot;Logit of `x`, clipped to avoid inf.&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">clamp</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">clamp</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">random_adjust_brightness</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">max_value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Adjust brightness, *= scale_factor&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># single image</span>
        <span class="n">do</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>
        <span class="k">return</span> <span class="n">adjust_brightness</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">)</span> <span class="k">if</span> <span class="n">do</span> <span class="k">else</span> <span class="n">b</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># mini-batch</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">index_copy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">adjust_brightness</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">))</span>

<div class="viewcode-block" id="random_adjust_brightness">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.random_adjust_brightness">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">random_adjust_brightness</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">max_value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Adjust brightness, *= scale_factor&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># single image</span>
        <span class="n">do</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>
        <span class="k">return</span> <span class="n">adjust_brightness</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">)</span> <span class="k">if</span> <span class="n">do</span> <span class="k">else</span> <span class="n">b</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># mini-batch</span>
        <span class="n">b</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">adjust_brightness</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">b</span></div>



<span class="c1"># =================================================</span>
<span class="c1">#  CONTRAST</span>
<span class="c1"># =================================================</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">adjust_contrast</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    
    <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">_get_scale_factor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">to_grayscale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_output_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mf">.5</span><span class="o">/</span><span class="mi">255</span><span class="o">*</span><span class="n">max_value</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">scale_factor</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">])</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">to_grayscale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_output_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">+</span><span class="mf">.5</span><span class="o">/</span><span class="mi">255</span><span class="o">*</span><span class="n">max_value</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">mean</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">scale_factor</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">out</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">adjust_contrast</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    
    <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">_get_scale_factor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">to_grayscale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_output_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">.5</span><span class="o">/</span><span class="mi">255</span><span class="o">*</span><span class="n">max_value</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">scale_factor</span><span class="p">))[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">to_grayscale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_output_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">+</span><span class="mf">.5</span><span class="o">/</span><span class="mi">255</span><span class="o">*</span><span class="n">max_value</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">mean</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">scale_factor</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">out</span>

<div class="viewcode-block" id="adjust_contrast">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.adjust_contrast">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">adjust_contrast</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">255</span><span class="p">):</span>
    <span class="n">enhancer</span> <span class="o">=</span> <span class="n">ImageEnhance</span><span class="o">.</span><span class="n">Contrast</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">enhanced_im</span> <span class="o">=</span> <span class="n">enhancer</span><span class="o">.</span><span class="n">enhance</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">enhanced_im</span></div>


<div class="viewcode-block" id="adjust_contrast_logit">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.adjust_contrast_logit">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">adjust_contrast_logit</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">255.</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">scale_factor</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">to_grayscale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_output_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="mf">.5</span><span class="o">/</span><span class="mi">255</span><span class="o">*</span><span class="n">max_value</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">scale_factor</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">])</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">z_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)</span>
        <span class="n">z_new</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">z_new</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">z_new</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">to_grayscale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_output_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">+</span><span class="mf">.5</span><span class="o">/</span><span class="mi">255</span><span class="o">*</span><span class="n">max_value</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">mean</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">scale_factor</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="adjust_contrast_pil">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.adjust_contrast_pil">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">adjust_contrast_pil</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">contrast</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">255.</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Adjust contrast like PIL ImageEnhance&#39;&#39;&#39;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">to_grayscale</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">+</span><span class="mf">.5</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">mean</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">contrast</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">contrast</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="adjust_rms_contrast">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.adjust_rms_contrast">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">adjust_rms_contrast</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">contrast</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">255.</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Adjust the RMS contrast (std of the pixel intensities)&#39;&#39;&#39;</span>
    <span class="n">gray</span> <span class="o">=</span> <span class="n">to_grayscale</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">gray</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">gray</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">std</span><span class="p">)</span>
    <span class="n">z_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">std</span> <span class="o">*</span> <span class="n">contrast</span><span class="p">)</span> <span class="o">+</span> <span class="n">mean</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">z_new</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span></div>


<div class="viewcode-block" id="adjust_rms_contrast_logit">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.adjust_rms_contrast_logit">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">adjust_rms_contrast_logit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">contrast</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">255.</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Adjust the RMS contrast (std of the log pixel intensities)&#39;&#39;&#39;</span>    
    <span class="n">gray</span> <span class="o">=</span> <span class="n">to_grayscale</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">max_value</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">max_value</span>
    <span class="n">x</span><span class="p">,</span><span class="n">gray</span> <span class="o">=</span> <span class="n">logit</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">logit</span><span class="p">(</span><span class="n">gray</span><span class="p">)</span>
    <span class="n">mean</span><span class="p">,</span><span class="n">std</span> <span class="o">=</span> <span class="n">gray</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">gray</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">std</span><span class="p">)</span>
    <span class="n">z_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">std</span> <span class="o">*</span> <span class="n">contrast</span><span class="p">)</span> <span class="o">+</span> <span class="n">mean</span>
    <span class="n">z_new</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">z_new</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">z_new</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">max_value</span></div>


<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">random_adjust_contrast</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">max_value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Adjust brightness, *= scale_factor&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># single image</span>
        <span class="n">do</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>
        <span class="k">return</span> <span class="n">adjust_contrast</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">)</span> <span class="k">if</span> <span class="n">do</span> <span class="k">else</span> <span class="n">b</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># mini-batch</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">index_copy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">adjust_contrast</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">))</span>

<div class="viewcode-block" id="random_adjust_contrast">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.random_adjust_contrast">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">random_adjust_contrast</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">max_value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Adjust brightness, *= scale_factor&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># single image</span>
        <span class="n">do</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>
        <span class="k">return</span> <span class="n">adjust_contrast</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">)</span> <span class="k">if</span> <span class="n">do</span> <span class="k">else</span> <span class="n">b</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># mini-batch</span>
        <span class="n">b</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">adjust_contrast</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">b</span></div>


<span class="c1"># =================================================</span>
<span class="c1">#  affine transforms</span>
<span class="c1"># =================================================</span>

<div class="viewcode-block" id="_prepare_mat">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional._prepare_mat">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_mat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;prepare transformation matrix `mat` to apply to ImageBatch `x` using _grid_sample</span>
<span class="sd">        from https://github.com/fastai/fastai2/blob/master/fastai2/vision/augment.py</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">h</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">mat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">h</span><span class="o">/</span><span class="n">w</span>
    <span class="n">mat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">w</span><span class="o">/</span><span class="n">h</span>
    <span class="k">return</span> <span class="n">mat</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span></div>


<div class="viewcode-block" id="_grid_sample">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional._grid_sample">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_grid_sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;reflection&#39;</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Resample pixels in `coords` from `x` by `mode`, with `padding_mode` in (&#39;reflection&#39;,&#39;border&#39;,&#39;zeros&#39;).</span>
<span class="sd">        from https://github.com/fastai/fastai2/blob/master/fastai2/vision/augment.py</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1">#coords = coords.permute(0, 3, 1, 2).contiguous().permute(0, 2, 3, 1) # optimize layout for grid_sample</span>
    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;bilinear&#39;</span><span class="p">:</span> <span class="c1"># hack to get smoother downwards resampling</span>
        <span class="n">mn</span><span class="p">,</span><span class="n">mx</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">coords</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="c1"># max amount we&#39;re affine zooming by (&gt;1 means zooming in)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">mx</span><span class="o">-</span><span class="n">mn</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">*</span><span class="mi">2</span>
        <span class="c1"># amount we&#39;re resizing by, with 100% extra margin</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
        <span class="c1"># If we&#39;re resizing up by &gt;200%, and we&#39;re zooming less than that, interpolate first</span>
        <span class="k">if</span> <span class="n">d</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">d</span><span class="o">&gt;</span><span class="n">z</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">d</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;area&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="n">padding_mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="n">align_corners</span><span class="p">)</span></div>


<div class="viewcode-block" id="affine_transform">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.affine_transform">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">affine_transform</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">sz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">pad_mode</span> <span class="o">=</span> <span class="s1">&#39;reflection&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;apply affine transformation matrix `mat` using _grid_sample&#39;&#39;&#39;</span>

    <span class="c1"># work with single Image or ImageBatch</span>
    <span class="n">expanded</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">expanded</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
    <span class="c1"># apply transformation</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span> <span class="k">if</span> <span class="n">sz</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">sz</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sz</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">affine_grid</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="n">align_corners</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">_grid_sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="n">pad_mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="n">align_corners</span><span class="p">)</span>
    
    <span class="c1"># single image in, single image out</span>
    <span class="k">if</span> <span class="n">expanded</span><span class="p">:</span> <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">out</span></div>


<span class="c1"># =================================================</span>
<span class="c1">#  affine horizontal flip</span>
<span class="c1"># =================================================</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">flip_mat</span><span class="p">(</span><span class="n">flip</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;create transformation matrix for horizontal flip</span>
<span class="sd">        flip: flip values inserted into matrix; -1 (flip) or 1 (don&#39;t flip)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">flip</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">flip</span> <span class="o">=</span> <span class="n">flip</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flip</span><span class="p">)</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">flip</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">flip</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">flip</span>
    <span class="k">return</span> <span class="n">mat</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">flip_mat</span><span class="p">(</span><span class="n">flip</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">flip_mat</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">flip</span><span class="p">))</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">flip_mat</span><span class="p">(</span><span class="n">flip</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">flip_mat</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">flip</span><span class="p">]))</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">flip_mat</span><span class="p">(</span><span class="n">flip</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">flip_mat</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">flip</span><span class="p">]))</span>

<div class="viewcode-block" id="flip_mat">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.flip_mat">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">flip_mat</span><span class="p">(</span><span class="n">flip</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">flip</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

    
    
<span class="c1"># =================================================</span>
<span class="c1">#  affine rotation</span>
<span class="c1"># =================================================</span>

<span class="n">pi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">])</span>

<span class="c1"># -------------------------------</span>
<span class="c1"># prepare thetas</span>
<span class="c1"># -------------------------------</span>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_thetas</span><span class="p">(</span><span class="n">thetas</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">thetas</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">thetas</span> <span class="o">=</span> <span class="n">thetas</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">thetas</span> <span class="o">=</span> <span class="n">thetas</span> <span class="o">*</span> <span class="n">pi</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">thetas</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">/</span> <span class="mf">180.</span>
    <span class="k">if</span> <span class="n">thetas</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">thetas</span> <span class="o">=</span> <span class="n">thetas</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thetas</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_thetas</span><span class="p">(</span><span class="n">thetas</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">thetas</span><span class="p">))</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_thetas</span><span class="p">(</span><span class="n">thetas</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">radians</span><span class="p">(</span><span class="n">thetas</span><span class="p">)])</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_thetas</span><span class="p">(</span><span class="n">thetas</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">radians</span><span class="p">(</span><span class="n">thetas</span><span class="p">)])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_thetas</span><span class="p">(</span><span class="n">thetas</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">thetas</span> <span class="o">=</span> <span class="p">[</span><span class="n">radians</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">thetas</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">thetas</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

<div class="viewcode-block" id="_prepare_thetas">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional._prepare_thetas">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_thetas</span><span class="p">(</span><span class="n">thetas</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">thetas</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<span class="c1"># -------------------------------</span>
<span class="c1"># prepare coords</span>
<span class="c1"># -------------------------------</span>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">coords</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">coords</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_prepare_coords</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_prepare_coords</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">coords</span><span class="p">))</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_prepare_coords</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_prepare_coords</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>

<div class="viewcode-block" id="_prepare_coords">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional._prepare_coords">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected `coords` type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="_prepare_rot_pt">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional._prepare_rot_pt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_rot_pt</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;convert coordinates from pixel coordinates to image-centered [-1,1] coordinates&#39;&#39;&#39;</span>
    <span class="n">h</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">/</span> <span class="n">w</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">/</span> <span class="n">h</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">xs</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">xs</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ys</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span></div>


<span class="c1"># -------------------------------</span>
<span class="c1"># prepare param</span>
<span class="c1"># -------------------------------</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_param</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">param</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_param</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_param</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">param</span><span class="p">])</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_param</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">param</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_param</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

<div class="viewcode-block" id="_prepare_param">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional._prepare_param">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_param</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<span class="c1"># -------------------------------</span>
<span class="c1"># rotation</span>
<span class="c1"># -------------------------------</span>

<div class="viewcode-block" id="rotate_mat">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.rotate_mat">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rotate_mat</span><span class="p">(</span><span class="n">degrees</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;create transformation matrix for rotation by `theta` degrees aground point x,y</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">thetas</span> <span class="o">=</span> <span class="n">_prepare_thetas</span><span class="p">(</span><span class="n">degrees</span><span class="p">)</span> <span class="c1"># convert to tensor, radians</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">_prepare_coords</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># convert to tensor, rescale from [0,1] to [-1,1]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">_prepare_coords</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="c1"># convert to tensor, rescale from [0,1] to [-1,1]</span>
    
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thetas</span><span class="p">)</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">thetas</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cos_theta</span> <span class="o">=</span> <span class="n">thetas</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span>
    <span class="n">sin_theta</span> <span class="o">=</span> <span class="n">thetas</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>

    <span class="n">r00</span> <span class="o">=</span> <span class="n">cos_theta</span>
    <span class="n">r01</span> <span class="o">=</span> <span class="n">sin_theta</span>
    <span class="n">r10</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin_theta</span>
    <span class="n">r11</span> <span class="o">=</span> <span class="n">cos_theta</span>
    
    <span class="n">mat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">r00</span>
    <span class="n">mat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r01</span>
    <span class="n">mat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">r00</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="n">r01</span><span class="o">*</span><span class="n">y</span>
    <span class="n">mat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">r10</span>
    <span class="n">mat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r11</span>
    <span class="n">mat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">r10</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="n">r11</span><span class="o">*</span><span class="n">y</span>

    <span class="k">return</span> <span class="n">mat</span></div>


<div class="viewcode-block" id="rotate">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.rotate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rotate</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ys</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">pad_mode</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;rotate image(s) `b` by `theta(s)` around (x,y) points `xs` and `ys`.</span>
<span class="sd">    </span>
<span class="sd">    Works with a single image, or multiple images, on the cpu or gpu.</span>
<span class="sd">    Images are assumed to be TensorImage [CxHxW] or TensorBatch [NxCxHxW].</span>
<span class="sd">    </span>
<span class="sd">    For multiple images, each image will be rotated by the same theta if</span>
<span class="sd">    only one theta value is passed. To rotate images individually, pass</span>
<span class="sd">    one theta per image (as a list, np array, or tensor).</span>
<span class="sd">    </span>
<span class="sd">    If a single image is passed with multiple thetas, that image will</span>
<span class="sd">    be rotated N times (N = number of thetas).</span>
<span class="sd">    </span>
<span class="sd">    Center of rotation can also be set once for all images (set a single x,y value),</span>
<span class="sd">    or individually for each image by passing one x,y per image (as list, np array</span>
<span class="sd">    or tensor). Position is specified as pct of image (e.g., .5,.5 is the image center)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        b (tensor): TensorImage or TensorImageBatch</span>
<span class="sd">        thetas (any): angle of rotation in degrees</span>
<span class="sd">        xs (any): center of rotation x-coordinate [0,1; .5=horizontal center of image]</span>
<span class="sd">        ys (any): center of rotation y-coordinate [0,1; .5=vertical center of image]</span>
<span class="sd">    &#39;&#39;&#39;</span>        
    <span class="n">mat</span> <span class="o">=</span> <span class="n">rotate_mat</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">_prepare_mat</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> 
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">affine_transform</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">mat</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">pad_mode</span><span class="o">=</span><span class="n">pad_mode</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>



<span class="c1"># =================================================</span>
<span class="c1">#  zoom</span>
<span class="c1"># =================================================</span>

<div class="viewcode-block" id="zoom_mat">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.zoom_mat">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">zoom_mat</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">col_pct</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">row_pct</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;create transformation matrix for zoom / scale</span>
<span class="sd">        scale: scale values</span>
<span class="sd">        col_pct: horizontal position [0,1] upon which to center zoom [.5 = horizontal center of image]</span>
<span class="sd">        row_pct: vertical position [0,1] upon which to center zoom [.5 = vertical center of image]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">_prepare_param</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
    <span class="n">col_pct</span> <span class="o">=</span> <span class="n">_prepare_param</span><span class="p">(</span><span class="n">col_pct</span><span class="p">)</span>
    <span class="n">row_pct</span> <span class="o">=</span> <span class="n">_prepare_param</span><span class="p">(</span><span class="n">row_pct</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scale</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">zoom</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">scale</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">mat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
    <span class="n">mat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">scale</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">col_pct</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
    <span class="n">mat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">scale</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">row_pct</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mat</span></div>


<div class="viewcode-block" id="zoom">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.zoom">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">zoom</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">scales</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ys</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">pad_mode</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;zoom image(s) `b` by `scale(s)` around point(s) `xs`,`ys`.</span>
<span class="sd">    </span>
<span class="sd">    Works with a single image, or multiple images, on the cpu or gpu.</span>
<span class="sd">    Images are assumed to be TensorImage [CxHxW] or TensorBatch [NxCxHxW].</span>
<span class="sd">    </span>
<span class="sd">    For multiple images, each image will be zoomed by the same scale if</span>
<span class="sd">    only one scale value is passed. To scale images individually, pass</span>
<span class="sd">    one scale per image (as a list, np array, or tensor).</span>
<span class="sd">    </span>
<span class="sd">    If a single image is passed with multiple scales, that image will</span>
<span class="sd">    be scaled N times (where N is the number of scales).</span>
<span class="sd">    </span>
<span class="sd">    Center of zoom can also be set once for all images (set a single x,y value),</span>
<span class="sd">    or individually for each image by passing one x,y per image (as list, np array</span>
<span class="sd">    or tensor).</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        b (tensor): TensorImage or TensorImageBatch</span>
<span class="sd">        thetas (any): angle of rotation in degrees</span>
<span class="sd">        xs (any): center of zoom x-coordinate [0,1; .5=horizontal center of image]</span>
<span class="sd">        ys (any): center of zoom y-coordinate [0,1; .5=vertical center of image]</span>
<span class="sd">    &#39;&#39;&#39;</span>    
    <span class="n">mat</span> <span class="o">=</span> <span class="n">zoom_mat</span><span class="p">(</span><span class="n">scales</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">_prepare_mat</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> 
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">affine_transform</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">mat</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">pad_mode</span><span class="o">=</span><span class="n">pad_mode</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>


<span class="c1"># =================================================</span>
<span class="c1">#  object-centered rotation</span>
<span class="c1"># =================================================</span>

<div class="viewcode-block" id="translate_mat">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.translate_mat">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">translate_mat</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;create transformation matrix for translation</span>
<span class="sd">        tx: pct of image to translate in the horizontal direction</span>
<span class="sd">        ty: pct of image to translate in the vertical direction</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="n">_prepare_param</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="c1"># to tensor, then rescale from [0,1] to [-1,1]</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">_prepare_param</span><span class="p">(</span><span class="n">ty</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="c1"># to tensor, then rescale from [0,1] to [-1,1]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tx</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">mat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx</span>
    <span class="n">mat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ty</span>
    
    <span class="k">return</span> <span class="n">mat</span></div>


<div class="viewcode-block" id="rotate_object_mat">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.rotate_object_mat">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rotate_object_mat</span><span class="p">(</span><span class="n">degrees</span><span class="p">,</span> <span class="n">ctr_x</span><span class="p">,</span> <span class="n">ctr_y</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">dest_x</span><span class="p">,</span> <span class="n">dest_y</span><span class="p">):</span>
    
    <span class="n">mat</span> <span class="o">=</span> <span class="n">rotate_mat</span><span class="p">(</span><span class="n">degrees</span><span class="p">,</span> <span class="n">ctr_x</span><span class="p">,</span> <span class="n">ctr_y</span><span class="p">)</span>    
    
    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span> <span class="o">@</span> <span class="n">zoom_mat</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">col_pct</span><span class="o">=</span><span class="n">ctr_x</span><span class="p">,</span> <span class="n">row_pct</span><span class="o">=</span><span class="n">ctr_y</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">dest_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dest_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span> <span class="o">@</span> <span class="n">translate_mat</span><span class="p">(</span><span class="n">ctr_x</span><span class="o">-</span><span class="n">dest_x</span><span class="p">,</span> <span class="n">ctr_y</span><span class="o">-</span><span class="n">dest_y</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">mat</span></div>


<div class="viewcode-block" id="rotate_object">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.rotate_object">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rotate_object</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">degrees</span><span class="p">,</span> <span class="n">ctr_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ctr_y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dest_x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dest_y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pad_mode</span><span class="o">=</span><span class="s1">&#39;border&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;rotate image(s) `b` by `theta(s)` around (x,y) points `xs` and `ys`.</span>
<span class="sd">    </span>
<span class="sd">    Works with a single image, or multiple images, on the cpu or gpu.</span>
<span class="sd">    Images are assumed to be TensorImage [CxHxW] or TensorBatch [NxCxHxW].</span>
<span class="sd">    </span>
<span class="sd">    For multiple images, each image will be rotated by the same theta if</span>
<span class="sd">    only one theta value is passed. To rotate images individually, pass</span>
<span class="sd">    one theta per image (as a list, np array, or tensor).</span>
<span class="sd">    </span>
<span class="sd">    If a single image is passed with multiple thetas, that image will</span>
<span class="sd">    be rotated N times (N = number of thetas).</span>
<span class="sd">    </span>
<span class="sd">    Center of rotation can also be set once for all images (set a single x,y value),</span>
<span class="sd">    or individually for each image by passing one x,y per image (as list, np array</span>
<span class="sd">    or tensor). Position is specified as pct of image (e.g., .5,.5 is the image center)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        b (tensor): TensorImage or TensorImageBatch</span>
<span class="sd">        thetas (any): angle of rotation in degrees</span>
<span class="sd">        xs (any): center of rotation x-coordinate [0,1; .5=horizontal center of image]</span>
<span class="sd">        ys (any): center of rotation y-coordinate [0,1; .5=vertical center of image]</span>
<span class="sd">    &#39;&#39;&#39;</span>        
    
    <span class="n">mat</span> <span class="o">=</span> <span class="n">rotate_object_mat</span><span class="p">(</span><span class="n">degrees</span><span class="p">,</span> <span class="n">ctr_x</span><span class="p">,</span> <span class="n">ctr_y</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">dest_x</span><span class="p">,</span> <span class="n">dest_y</span><span class="p">)</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">_prepare_mat</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> 
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">affine_transform</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">mat</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">pad_mode</span><span class="o">=</span><span class="n">pad_mode</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>


<span class="c1"># =================================================</span>
<span class="c1">#  grid_sample</span>
<span class="c1"># =================================================</span>

<div class="viewcode-block" id="grid_sample">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.grid_sample">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">grid_sample</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">grid</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>            
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">*</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>    
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="n">align_corners</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">grid</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="n">align_corners</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unsupported shape, expected 3 or 4 dimensions, got: </span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">x</span></div>


<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">random_grid_sample</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">b</span><span class="o">.</span><span class="n">index_copy_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="n">grid</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="n">align_corners</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">b</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">do</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">grid</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="n">align_corners</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">do</span> <span class="k">else</span> <span class="n">b</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unsupported shape, expected 3 or 4 dimensions, got: </span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="random_grid_sample">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.random_grid_sample">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">random_grid_sample</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

    
<span class="c1"># =================================================</span>
<span class="c1">#  apply_mask</span>
<span class="c1"># =================================================</span>

<div class="viewcode-block" id="apply_mask">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.apply_mask">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">apply_mask</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
         
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">mask</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unsupported shape, expected 3 or 4 dimensions, got: </span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">x</span></div>


<span class="c1"># =================================================</span>
<span class="c1">#  color space conversions</span>
<span class="c1"># =================================================</span>

<div class="viewcode-block" id="srgb_to_lrgb">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.srgb_to_lrgb">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">srgb_to_lrgb</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Converts a standard RGB image to linearized RGB.</span>
<span class="sd">    </span>
<span class="sd">    References:</span>
<span class="sd">        https://en.wikipedia.org/wiki/SRGB</span>
<span class="sd">        http://www.w3.org/Graphics/Color/sRGB</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        image (torch.Tensor): RGB Image to be converted to XYZ with shape :math:`(*, 3, H, W)`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: XYZ version of the image with shape :math:`(*, 3, H, W)`.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; input = torch.rand(2, 3, 4, 5)</span>
<span class="sd">        &gt;&gt;&gt; output = rgb_to_xyz(input)  # 2x3x4x5</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;srgb_to_lrgb: srgb appears to be outside the (0,1) range&#39;</span><span class="p">);</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input type is not a torch.Tensor. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">image</span><span class="p">)))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input size must have a shape of (*, 3, H, W). Got </span><span class="si">{}</span><span class="s2">&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">image</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        
    <span class="c1"># Change to linear rgb values (invgammacorrection)</span>
    <span class="n">big</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span> <span class="o">&gt;</span> <span class="mf">0.04045</span><span class="p">);</span>
    <span class="n">out</span><span class="p">[</span><span class="o">~</span><span class="n">big</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="o">~</span><span class="n">big</span><span class="p">]</span><span class="o">/</span><span class="mf">12.92</span><span class="p">;</span>
    <span class="n">out</span><span class="p">[</span><span class="n">big</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">big</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mf">0.055</span><span class="p">)</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mf">1.055</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">2.4</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>            </div>

        
<div class="viewcode-block" id="rgb_to_xyz">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.rgb_to_xyz">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rgb_to_xyz</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Converts a RGB image to XYZ.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (torch.Tensor): RGB Image to be converted to XYZ with shape :math:`(*, 3, H, W)`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: XYZ version of the image with shape :math:`(*, 3, H, W)`.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; input = torch.rand(2, 3, 4, 5)</span>
<span class="sd">        &gt;&gt;&gt; output = rgb_to_xyz(input)  # 2x3x4x5</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input type is not a torch.Tensor. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">image</span><span class="p">)))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input size must have a shape of (*, 3, H, W). Got </span><span class="si">{}</span><span class="s2">&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="n">r</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">g</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">b</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="mf">0.412453</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">0.357580</span> <span class="o">*</span> <span class="n">g</span> <span class="o">+</span> <span class="mf">0.180423</span> <span class="o">*</span> <span class="n">b</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="mf">0.212671</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">0.715160</span> <span class="o">*</span> <span class="n">g</span> <span class="o">+</span> <span class="mf">0.072169</span> <span class="o">*</span> <span class="n">b</span>
    <span class="n">z</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="mf">0.019334</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">0.119193</span> <span class="o">*</span> <span class="n">g</span> <span class="o">+</span> <span class="mf">0.950227</span> <span class="o">*</span> <span class="n">b</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="xyz_to_lms">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.xyz_to_lms">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">xyz_to_lms</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Converts a XYZ image to CAT02 LMS.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (torch.Tensor): XYZ Image to be converted to LMS with shape :math:`(*, 3, H, W)`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: LMS version of the image with shape :math:`(*, 3, H, W)`.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; input = torch.rand(2, 3, 4, 5)</span>
<span class="sd">        &gt;&gt;&gt; output = xyz_to_lms(input)  # 2x3x4x5</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input type is not a torch.Tensor. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">image</span><span class="p">)))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input size must have a shape of (*, 3, H, W). Got </span><span class="si">{}</span><span class="s2">&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            
    <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">z</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="n">l</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span>  <span class="mf">0.7328</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">0.4296</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="o">-</span><span class="mf">0.1624</span> <span class="o">*</span> <span class="n">z</span>
    <span class="n">m</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.7036</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">1.6975</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span>  <span class="mf">0.0061</span> <span class="o">*</span> <span class="n">z</span>
    <span class="n">s</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span>  <span class="mf">0.0030</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">0.0136</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span>  <span class="mf">0.9834</span> <span class="o">*</span> <span class="n">z</span>
        
    <span class="n">out</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="srgb_to_lms">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.srgb_to_lms">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">srgb_to_lms</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Converts a standard RGB image -&gt; linear RGB -&gt; XYZ -&gt; to CAT02 LMS.</span>
<span class="sd">    </span>
<span class="sd">        LMS (long, medium, short), is a color space which represents the response of </span>
<span class="sd">        the three types of cones of the human eye, named for their responsivity </span>
<span class="sd">        (sensitivity) peaks at long, medium, and short wavelengths.</span>
<span class="sd">    </span>
<span class="sd">    References:</span>
<span class="sd">        https://en.wikipedia.org/wiki/LMS_color_space</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        image (torch.Tensor): sRGB Image to be converted to LMS with shape :math:`(*, 3, H, W)`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: LMS version of the image with shape :math:`(*, 3, H, W)`.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; input = torch.rand(2, 3, 4, 5)</span>
<span class="sd">        &gt;&gt;&gt; output = srgb_to_lms(input)  # 2x3x4x5</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">xyz_to_lms</span><span class="p">(</span> <span class="n">rgb_to_xyz</span><span class="p">(</span> <span class="n">srgb_to_lrgb</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="lms_to_lgrby">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.lms_to_lgrby">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">lms_to_lgrby</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Converts a standard LMS image to Luminance, R+,G+,B+,Y+ channels.</span>
<span class="sd">    </span>
<span class="sd">        LMS (long, medium, short), is a color space which represents the response of </span>
<span class="sd">        the three types of cones of the human eye, named for their responsivity </span>
<span class="sd">        (sensitivity) peaks at long, medium, and short wavelengths.                </span>
<span class="sd">    </span>
<span class="sd">    References:</span>
<span class="sd">        https://en.wikipedia.org/wiki/LMS_color_space</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        image (torch.Tensor): sRGB Image to be converted to LMS with shape :math:`(*, 3, H, W)`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: LMS version of the image with shape :math:`(*, 3, H, W)`.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; input = torch.rand(2, 3, 4, 5)</span>
<span class="sd">        &gt;&gt;&gt; output = srgb_to_lms(input)  # 2x3x4x5</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">S</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,:,:],</span> <span class="n">image</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,:],</span> <span class="n">image</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">,:,:]</span>
    
    <span class="n">l</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">L</span> <span class="o">+</span> <span class="n">M</span>
    <span class="n">r</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">L</span> <span class="o">-</span> <span class="n">M</span><span class="p">)</span>
    <span class="n">g</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">M</span> <span class="o">-</span> <span class="n">L</span><span class="p">)</span>
    <span class="n">b</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">S</span> <span class="o">-</span> <span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="mf">.5</span><span class="o">+</span><span class="n">L</span><span class="o">*</span><span class="mf">.5</span><span class="p">))</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">((</span><span class="n">M</span><span class="o">*</span><span class="mf">.5</span><span class="o">+</span><span class="n">L</span><span class="o">*</span><span class="mf">.5</span><span class="p">)</span> <span class="o">-</span> <span class="n">S</span><span class="p">)</span>
        
    <span class="n">out</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">y</span><span class="p">],</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">out</span></div>


<span class="c1"># =================================================</span>
<span class="c1">#  crop</span>
<span class="c1"># =================================================</span>

<div class="viewcode-block" id="crop">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.crop">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">crop</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">crop_height</span><span class="p">,</span> <span class="n">crop_width</span><span class="p">,</span> <span class="n">h_start</span><span class="p">,</span> <span class="n">w_start</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;crop_height, crop_width in pixels, h_start and w_start in percentage&#39;&#39;&#39;</span>
    <span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">h_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">h_start</span><span class="o">*</span><span class="n">h</span><span class="p">))</span>
    <span class="n">h_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">h_min</span><span class="o">+</span><span class="n">crop_height</span><span class="p">)</span>
    <span class="n">w_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">w_start</span><span class="o">*</span><span class="n">w</span><span class="p">))</span>
    <span class="n">w_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">w_min</span><span class="o">+</span><span class="n">crop_width</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="p">[</span><span class="n">h_min</span><span class="p">:</span><span class="n">h_max</span><span class="p">,</span><span class="n">w_min</span><span class="p">:</span><span class="n">w_max</span><span class="p">]</span></div>


<span class="c1"># =================================================</span>
<span class="c1">#  solarization</span>
<span class="c1"># =================================================</span>

<div class="viewcode-block" id="solarization">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.solarization">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">solarization</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">image</span> <span class="o">&gt;=</span> <span class="n">threshold</span>
    <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">uint8</span> <span class="ow">or</span> <span class="n">image</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">255</span> <span class="o">-</span> <span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># assume the image is a float tensor/array</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span></div>


<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">random_solarization</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Solarize random set of images in batch `b`&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># single image</span>
        <span class="n">do</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>
        <span class="k">return</span> <span class="n">solarization</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span> <span class="k">if</span> <span class="n">do</span> <span class="k">else</span> <span class="n">b</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># mini-batch</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">index_copy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">solarization</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="n">threshold</span><span class="p">))</span>

<div class="viewcode-block" id="random_solarization">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.random_solarization">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">random_solarization</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Solarize random set of images in batch `b`&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># single image</span>
        <span class="n">do</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>
        <span class="k">return</span> <span class="n">solarization</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span> <span class="k">if</span> <span class="n">do</span> <span class="k">else</span> <span class="n">b</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># mini-batch</span>
        <span class="n">b</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">solarization</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">threshold</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">b</span></div>

    
<span class="c1"># =================================================</span>
<span class="c1">#  random gaussian blur</span>
<span class="c1"># =================================================    </span>

<div class="viewcode-block" id="random_gaussian_blur2d">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.random_gaussian_blur2d">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">random_gaussian_blur2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">blur_indices</span><span class="p">,</span> <span class="n">selected_kernels</span><span class="p">,</span> <span class="n">kernels</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;symmetric&#39;</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blur_indices</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    
    <span class="n">bs</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">blur_indices</span> <span class="o">=</span> <span class="n">blur_indices</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">selected_kernels</span> <span class="o">=</span> <span class="n">selected_kernels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">kernels</span> <span class="o">=</span> <span class="n">kernels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="c1"># create stack of kernels, one per image to-be-blurred</span>
    <span class="n">kernel_stack</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">kernels</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">selected_kernels</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
    <span class="n">kernel_stack</span> <span class="o">=</span> <span class="n">kernel_stack</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># repeat for all channels</span>

    <span class="c1"># Create one big group convolution operator that applies all the kernels in one go:</span>
    <span class="n">kh</span><span class="p">,</span><span class="n">kw</span> <span class="o">=</span> <span class="n">kernel_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">padH</span><span class="p">,</span><span class="n">padW</span> <span class="o">=</span> <span class="n">kh</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">kw</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">x_blur</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">blur_indices</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">x_blur</span> <span class="o">=</span> <span class="n">tv_transforms</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x_blur</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="n">padH</span><span class="p">,</span><span class="n">padW</span><span class="p">),</span> <span class="n">padding_mode</span><span class="o">=</span><span class="n">padding_mode</span><span class="p">)</span>
    <span class="n">x_blur</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">x_blur</span><span class="p">,</span> 
                      <span class="n">kernel_stack</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">kw</span><span class="p">),</span> 
                      <span class="n">groups</span><span class="o">=</span><span class="n">blur_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span><span class="p">,</span> 
                      <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">x_blur</span> <span class="o">=</span> <span class="n">tv_transforms</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">center_crop</span><span class="p">(</span><span class="n">x_blur</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
    <span class="n">x_blur</span> <span class="o">=</span> <span class="n">x_blur</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    
    <span class="c1"># replace original values at blur_indices with blurred images</span>
    <span class="n">x</span><span class="p">[</span><span class="n">blur_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_blur</span>
    
    <span class="k">return</span> <span class="n">x</span> </div>


<span class="c1"># =================================================</span>
<span class="c1">#  batch of random permuations</span>
<span class="c1"># =================================================</span>

<div class="viewcode-block" id="generate_batch_permutations">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.generate_batch_permutations">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_batch_permutations</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a batch of permutations, each of size N, without using Python loops.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        batch_size (int): The number of permutations to generate.</span>
<span class="sd">        N (int): The size of each permutation.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: A (batch_size x N) tensor where each row is a random permutation of 0 to N-1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a 2D tensor where each row is the range [0, N)</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Apply a random permutation to each row using argsort on a random set of numbers for each row</span>
    <span class="n">random_rows</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">random_rows</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Gather the base numbers according to the sorted indices</span>
    <span class="n">permutations</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">permutations</span></div>


<span class="c1"># =================================================</span>
<span class="c1">#  to torch image</span>
<span class="c1"># =================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_max_value</span><span class="p">(</span><span class="n">dtype</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">uint8</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">255</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">int8</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">127</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">int16</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">32767</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">int32</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2147483647</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">int64</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">9223372036854775807</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># This is only here for completeness. This value is implicitly assumed in a lot of places so changing it is not</span>
        <span class="c1"># easy.</span>
        <span class="k">return</span> <span class="mi">1</span>
    
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">to_torch_image</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">from_numpy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;convert to torch image; assumes HxWxC&#39;&#39;&#39;</span>    
    
    <span class="k">if</span> <span class="n">from_numpy</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    
    <span class="n">b</span> <span class="o">=</span> <span class="n">to_channels_first</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    
    <span class="n">max_val</span> <span class="o">=</span> <span class="n">_max_value</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">div_</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">max_val</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">b</span>

<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">to_torch_image</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;convert to torch image; assumes HxWxC or BxHxWxC&#39;&#39;&#39;</span>
    
    <span class="n">max_val</span> <span class="o">=</span> <span class="n">_max_value</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">to_channels_first</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">div_</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">max_val</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">b</span>

<div class="viewcode-block" id="to_torch_image">
<a class="viewcode-back" href="../../../../api/foveation.utils.fastaugs.functional.html#foveation.utils.fastaugs.functional.to_torch_image">[docs]</a>
<span class="nd">@typedispatch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">to_torch_image</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">from_numpy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>